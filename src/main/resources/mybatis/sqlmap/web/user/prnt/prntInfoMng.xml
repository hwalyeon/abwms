<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="user.prnt.prntInfoMng">

	<!--보호자(사용자)정보_리스트 조회 -->
	<select id="selectPrntInfoList"	parameterType="java.util.Map" resultType="MybatisMap">

	  select      TGB.GUAR_NO as GUAR_NO_TEMP -- 보호자_번호_임시
				, TSB.STDT_NO      -- 학생_번호
				, TSB.STDT_NM      -- 학생_명
				, TGB.ENTR_DT      -- 가입_일자
				, TBI.TEL_NO       -- BAND전화_번호
				, LIB.LOC_NM       -- 위치_명
				, TBI.BAND_ID      -- 밴드ID
				, TGB.GUAR_NO      -- 보호자_번호
				, TGB.GUAR_NM      -- 보호자_명
				, TGB.GUAR_TEL_NO  -- 보호자_전화_번호
				, TGB.SPOS_NO      -- 배우자_번호
				, TSB2.SPOS_NM     -- 배우자_명
				, TSB2.SPOS_TEL_NO -- 배우자_전화_번호
				, TSB.EORG_LOC_NO  -- 교육시설_위치_번호
				, fn_getCdNm('TERM_DIV_CD', TERM_DIV_CD) as TERM_DIV_CD -- 약관_구분_명
				, TTAD.TERM_AGRE_YN-- 약관_동의_여부
		from      TM_GUAR_BASE TGB
		left outer join  TM_STDT_BASE TSB
		on TGB.GUAR_NO = TSB.GUAR_NO_1 or TGB.GUAR_NO = TSB.GUAR_NO_2
		left outer JOIN  TM_SPOS_BASE TSB2
		on TGB.SPOS_NO = TSB2.SPOS_NO
		left outer JOIN  TS_LOC_INFO_BASE LIB
		on TSB.EORG_LOC_NO = LIB.LOC_NO
		left outer JOIN  TM_TERM_AGRE_DETL TTAD
		on TGB.GUAR_NO = TTAD.GUAR_NO
		left outer JOIN  TS_BAND_INFO TBI
		on TSB.BAND_ID = TBI.BAND_ID
		where 1=1
		<if test="entrDtFr != null and entrDtFr != null and entrDtTo !='' and entrDtTo !='' ">
			and TGB.ENTR_DT between #{entrDtFr} and #{entrDtTo}</if>
		<if test=" stdtNo != null and stdtNo !='' ">
			and TSB.STDT_NO = #{stdtNo}::NUMERIC </if>
		<if test=" stdtNm != null and stdtNm !='' ">
			and TSB.STDT_NM like CONCAT('%',#{stdtNm},'%')</if>
		<if test=" bandId != null and bandId !='' ">
			and TBI.BAND_ID like CONCAT('%',#{bandId},'%')</if>
		<if test=" telNo != null and telNo !='' ">
			and TBI.TEL_NO = #{telNo}</if>
		<if test=" guarNo != null and guarNo !='' ">
			and TGB.GUAR_NO = #{guarNo}::NUMERIC </if>
		<if test=" guarNm != null and guarNm !='' ">
			and TGB.GUAR_NM like CONCAT('%',#{guarNm},'%')</if>
		<if test=" guarTelNo != null and guarTelNo !='' ">
			and TGB.GUAR_TEL_NO = #{guarTelNo}</if>
		ORDER BY TSB.STDT_NO, TSB.STDT_NM, TGB.ENTR_DT, LIB.LOC_NM, TBI.BAND_ID, TGB.GUAR_NO,TGB.GUAR_NM, TGB.SPOS_NO , TSB2.SPOS_NM , TSB2.SPOS_TEL_NO
		<if test=' paging == "Y" '>
			LIMIT ${rowCount} OFFSET ${currentIndex}
		</if>
		
	</select>


	<insert id="insertTsPrntInfoList" parameterType="java.util.Map">
		<selectKey keyProperty="guarNo" resultType="int" order="BEFORE">
			select nextval('absv.tm_guar_base_seq')
		</selectKey>
		INSERT INTO TM_GUAR_BASE
		(     guar_no 			 /* guar_no 보호자_번호 numeric */
			, guar_nm 			 /* guar_nm 보호자_명 character varying(20) */
			, guar_tel_no 		 /* guar_tel_no 보호자_전화_번호 character varying(20) */
			, guar_pw 			 /* guar_pw 보호자_비밀번호 character varying(1000) */
			, self_cert_dttm 	 /* self_cert_dttm 본인_인증_일시 character(14) */
			, auto_login_yn      /* auto_login_yn 자동_로그인_여부 bpchar(1)*/
			, devc_cert_val      /* devc_cert_val 장치_인증_값*/
			, race_div_cd 		 /* race_div_cd 인종_구분_코드 character varying(20) */
			, sex_cd 			 /* sex_cd 성별_코드 character varying(20) */
			, hght_val 			 /* hght_val 키_값 numeric */
			, wght_val		 	 /* wght_val 체중_값 numeric */
			, bmi_val 			 /* bmi_val BMI_값 numeric */
		<if test="sposNo != null and sposNo !=''">
			, spos_no 			 /* spos_no 배우자_번호 numeric */
		</if>
			, dzone_moin_alam_yn /* dzone_moin_alam_yn 위험지역_진입_알림_여부 character(1) */
			, dzone_mout_alam_yn /* dzone_mout_alam_yn 위험지역_이탈_알림_여부 character(1) */
			, szone_moin_alam_yn /* szone_moin_alam_yn 세이프존_진입_알림_여부 character(1) */
			, szone_mout_alam_yn /* szone_mout_alam_yn 세이프존_이탈_알림_여부 character(1) */
			, fall_occr_alam_yn  /* fall_occr_alam_yn 낙상_발생_알림_여부 character(1) */
			, strs_abnm_alam_yn  /* strs_abnm_alam_yn 스트레스_이상_알림_여부 character(1) */
		<if test="entrDt != null and entrDt !=''">
			, entr_dt			 /* entr_dt 가입_일자 character(8) */
		</if>
		<if test="relsDt != null and relsDt !=''">
			, rels_dt 			 /* rels_dt 해지_일자 character(8) */
		</if>
			, rels_resn_cd 		 /* rels_resn_cd 해지_사유_코드 character varying(20) */
			, rels_resn_cntn  	 /* rels_resn_cntn 해지_사유_내용 character varying(400) */
			, entr_stat_cd 		 /* entr_stat_cd 가입_상태_코드 character varying(20) */
			, reg_dt 			 /* reg_dt 등록_일자 character(8) */
			, reg_tm 		     /* reg_tm 등록_시각 character(6) */
			, reg_user_id 		 /* reg_user_id 등록_사용자_ID character varying(20) */
			, upt_dt 			 /* upt_dt 수정_일자 character(8) */
			, upt_tm			 /* upt_tm 수정_시각 character(6) */
			, upt_user_id 		 /* upt_user_id 수정_사용자_ID character varying(20) */
		)
		VALUES
		(
		 	  #{guarNo}
			, #{guarNm}
			, #{guarTelNo}
			, #{guarPw}
			, #{selfCertDttm}
			, #{autoLoginYn}
			, #{devcCertVal}
			, #{raceDivCd}
			, #{sexCd}
			, #{hghtVal}::numeric
			, #{wghtVal}::numeric
			, #{bmiVal}::numeric
		<if test="sposNo != null and sposNo !=''">
			, #{sposNo}::numeric
		</if>
			, #{dzoneMoinAlamYn}
			, #{dzoneMoutAlamYn}
			, #{szoneMoinAlamYn}
			, #{szoneMoutAlamYn}
			, #{fallOccrAlamYn}
			, #{strsAbnmAlamYn}
		<if test="entrDt != null and entrDt !=''">
			, replace(#{entrDt} , '-','')
		</if>
		<if test="relsDt != null and relsDt !=''">
			, replace(#{relsDt} , '-','')
		</if>
			, #{relsResnCd}
			, #{relsResnCntn}
			, #{entrStatCd}
			, TO_CHAR(NOW(), 'YYYYMMDD')
			, TO_CHAR(NOW(), 'HH24MISS')
			, #{regUserId}
			, TO_CHAR(NOW(), 'YYYYMMDD')
			, TO_CHAR(NOW(), 'HH24MISS')
			, #{uptUserId}
		)
	</insert>

	<update id="updateTsPrntInfoList" parameterType="java.util.Map">
		UPDATE TM_GUAR_BASE
		SET    UPT_DT = TO_CHAR(NOW(), 'YYYYMMDD')
		     , UPT_TM = TO_CHAR(NOW(),'HH24MISS')
		     , UPT_USER_ID = #{uptUserId}
		<if test="guarNo != null and guarNo !=''">            , guar_no        = #{guarNo}           </if>
		<if test="guarNm != null and guarNm !=''">            , guar_nm        = #{guarNm}			 </if>
		<if test="guarTelNo != null and guarTelNo !=''">      , guar_tel_no    = #{guarTelNo}		 </if>
		<if test="guarPw != null and guarPw !=''">    		  , guar_pw        = #{guarPw}			 </if>
		<if test="selfCertDttm != null and selfCertDttm !=''">, self_cert_dttm = #{selfCertDttm}	 </if>
		<if test="autoLoginYn != null and autoLoginYn !=''">  , auto_login_yn  = #{autoLoginYn}		 </if>
		<if test="devcCertVal != null and devcCertVal !=''">  , devc_cert_val  = #{devcCertVal}		 </if>
		<if test="raceDivCd != null and raceDivCd !=''">      , race_div_cd    = #{raceDivCd}		 </if>
		<if test="sexCd != null and sexCd !=''"> 			  , sex_cd 	       = #{sexCd}			 </if>
		<if test="hghtVal != null and hghtVal !=''">		  , hght_val	   = #{hghtVal}::numeric </if>
		<if test="wghtVal != null and wghtVal !=''">  		  , wght_val 	   = #{wghtVal}::numeric </if>
		<if test="bmiVal != null and bmiVal !=''">			  , bmi_val        = #{bmiVal}::numeric  </if>
		<if test="sposNo != null and sposNo !=''">		      , spos_no        = #{sposNo}::numeric  </if>
		<if test="dzoneMoinAlamYn != null and dzoneMoinAlamYn !=''">, dzone_moin_alam_yn = #{dzoneMoinAlamYn}  </if>
		<if test="dzoneMoutAlamYn != null and dzoneMoutAlamYn !=''">, dzone_mout_alam_yn = #{dzoneMoutAlamYn}  </if>
		<if test="szoneMoinAlamYn != null and szoneMoinAlamYn !=''">, szone_moin_alam_yn = #{szoneMoinAlamYn}  </if>
		<if test="szoneMoutAlamYn != null and szoneMoutAlamYn !=''">, szone_mout_alam_yn = #{szoneMoutAlamYn}  </if>
		<if test="fallOccrAlamYn != null and fallOccrAlamYn !=''">	, fall_occr_alam_yn  = #{fallOccrAlamYn}   </if>
		<if test="strsAbnmAlamYn != null and strsAbnmAlamYn !=''">	, strs_abnm_alam_yn  = #{strsAbnmAlamYn}   </if>
		<if test="entrDt != null and entrDt !=''">					,  entr_dt	         = replace(#{entrDt} , '-','')	</if>
		<if test="relsDt != null and relsDt !=''">					,  rels_dt 	         = replace(#{relsDt} , '-','')	</if>
		<if test="relsResnCd != null and relsResnCd !=''">			,  rels_resn_cd 	 = #{relsResnCd}   	</if>
		<if test="relsResnCntn != null and relsResnCntn !=''">		,  rels_resn_cntn    = #{relsResnCntn}	</if>
		<if test="entrStatCd != null and entrStatCd !=''">			,  entr_stat_cd 	 = #{entrStatCd}	</if>
		WHERE 1=1
		AND GUAR_NO = #{guarNoTemp}
	</update>

	<delete id="deleteTsPrntInfoList" parameterType="java.util.Map">
		DELETE
		FROM TM_GUAR_BASE
		WHERE 1=1
		AND GUAR_NO = #{guarNoTemp}

	</delete>

	<!--보호자(사용자)_정보_상세보기 -->
	<select id="selectPrntInfoDetl" parameterType="java.util.Map" resultType="MybatisMap">
		/* Generated SQL SQL ID : tm_guar_base.select */
		SELECT    guar_no             as guar_no_temp
		  		, guar_no 			 /* guar_no 보호자_번호 numeric */
				, guar_nm 			 /* guar_nm 보호자_명 character varying(20) */
				, guar_tel_no 		 /* guar_tel_no 보호자_전화_번호 character varying(20) */
				, guar_pw 			 /* guar_pw 보호자_비밀번호 character varying(1000) */
				, self_cert_dttm 	 /* self_cert_dttm 본인_인증_일시 character(14) */
				, auto_login_yn      /* auto_login_yn 자동_로그인_여부 bpchar(1)*/
				, devc_cert_val      /* devc_cert_val 장치_인증_값*/
				, race_div_cd 		 /* race_div_cd 인종_구분_코드 character varying(20) */
				, sex_cd 			 /* sex_cd 성별_코드 character varying(20) */
				, hght_val 			 /* hght_val 키_값 numeric */
				, wght_val		 	 /* wght_val 체중_값 numeric */
				, bmi_val 			 /* bmi_val BMI_값 numeric */
				, spos_no 			 /* spos_no 배우자_번호 numeric */
				, dzone_moin_alam_yn /* dzone_moin_alam_yn 위험지역_진입_알림_여부 character(1) */
				, dzone_mout_alam_yn /* dzone_mout_alam_yn 위험지역_이탈_알림_여부 character(1) */
				, szone_moin_alam_yn /* szone_moin_alam_yn 세이프존_진입_알림_여부 character(1) */
				, szone_mout_alam_yn /* szone_mout_alam_yn 세이프존_이탈_알림_여부 character(1) */
				, fall_occr_alam_yn  /* fall_occr_alam_yn 낙상_발생_알림_여부 character(1) */
				, strs_abnm_alam_yn  /* strs_abnm_alam_yn 스트레스_이상_알림_여부 character(1) */
				, entr_dt			 /* entr_dt 가입_일자 character(8) */
				, rels_dt 			 /* rels_dt 해지_일자 character(8) */
				, rels_resn_cd 		 /* rels_resn_cd 해지_사유_코드 character varying(20) */
				, rels_resn_cntn  	 /* rels_resn_cntn 해지_사유_내용 character varying(400) */
				, entr_stat_cd 		 /* entr_stat_cd 가입_상태_코드 character varying(20) */
				, reg_dt 			 /* reg_dt 등록_일자 character(8) */
				, reg_tm 		     /* reg_tm 등록_시각 character(6) */
				, reg_user_id 		 /* reg_user_id 등록_사용자_ID character varying(20) */
				, upt_dt 			 /* upt_dt 수정_일자 character(8) */
				, upt_tm			 /* upt_tm 수정_시각 character(6) */
				, upt_user_id 		 /* upt_user_id 수정_사용자_ID character varying(20) */
		FROM   tm_guar_base
		WHERE  1 = 1
		AND    guar_no = #{guarNo}::NUMERIC  /* guar_no 보호자_번호 numeric */

	</select>


</mapper>