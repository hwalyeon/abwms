<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="user.stdt.stdtInfoMng">

       <!-- 학생정보 리스트 조회 -->
       <select id="searchStdtInfoList" parameterType="java.util.Map" resultType="MybatisMap">
              select   	   B.ENTR_DT/*가입일자*/
              ,B.GUAR_NO/*학부모번호*/
              ,B.GUAR_NM/*학부모명*/
              ,C.PRNT_NM/*학부모1*/
              ,CC.PRNT_NM as prnt_nm2/*학부모2*/
              ,A.STDT_NO/*학생번호*/
              ,A.STDT_NM/*학생명*/
              ,I.TEL_NO/*전화번호*/
              ,fn_getCdNm('PLC_CLSS_CD',DDD.plc_clss_cd)as PLC_CLSS_NM/*현재위치분류*/
              ,concat('(',DDD.pstno,')',DDD.addr_base,DDD.addr_spec) as CURR_LOC
              ,H.DGEM_STAT_CD/*위험감정상태*/
              ,fn_getCdNm('DGEM_STAT_CD',H.DGEM_STAT_CD) as DGEM_STAT_NM
              ,F.STRS_IDX/*스트레스상태*/
              ,G.GROW_IDX/*성장상태*/
              ,G.FAT_IDX/*비만상태*/
              ,I.BAND_ID/*밴드ID*/
              ,I.TEL_NO/*전화번호*/
              ,I.BLTH_ID/*블루투스 ID*/
              ,A.SEX_CD/*성별*/
              ,fn_getCdNm('SEX_CD',A.SEX_CD) as SEX_NM
              ,A.BITH_DT/*생년월일*/
              ,D.LOC_NO/*소속학교번호*/
              ,D.LOC_NM/*소속학교명*/
              ,fn_getage(A.BITH_DT) as AGE/*나이*/
              ,A.BAND_STAT_CD/*현재상태*/
              ,fn_getCdNm('BAND_STAT_CD',A.BAND_STAT_CD) as BAND_STAT_NM
              ,ment_strs_stat_cd/* ment_strs_stat_cd 정신적_스트레스_상태_코드 character varying(20) */
              ,fn_getCdNm('STRS_STAT_CD', F.MENT_STRS_STAT_CD) AS MENT_STRS_STAT_NM
              ,phys_strs_stat_cd/* phys_strs_stat_cd 신체적_스트레스_상태_코드 character varying(20) */
              ,fn_getCdNm('STRS_STAT_CD', F.PHYS_STRS_STAT_CD) AS PHYS_STRS_STAT_NM
              ,(select SUM(USE_CBEE_AMT)
              from   TS_STDT_CBEE_HIST X
              where  X.STDT_NO = A.STDT_NO
              and    X.CBEE_USE_CD = 'SAVE') as SAVE_TOTAL /*적립 캐시비 사용금액*/
              ,(select SUM(USE_CBEE_AMT)
              from   TS_STDT_CBEE_HIST X
              where  X.STDT_NO = A.STDT_NO
              and    X.CBEE_USE_CD = 'USE')  as USE_TOTAL /*사용 사용금액*/
              ,K.CBEE_BAL/*캐시비 잔액*/
              from     TM_STDT_BASE A
              left outer join
              TS_STDT_LOC_HIST HI
              on       A.loc_hist_no = HI.LOC_HIST_NO
              left outer join
              TM_STDT_GUAR_CONN AA
              on       A.STDT_NO  = AA.STDT_NO
              left outer join
              TM_GUAR_BASE B
              on       AA.GUAR_NO = B.GUAR_NO
              left outer join
              TM_PRNT_BASE C
              on		 B.PRNT_NO   = C.PRNT_NO
              and        C.SEX_CD    = 'MALE'
              left outer join
              TM_PRNT_BASE CC
              on         B.PRNT_NO   = CC.PRNT_NO
              and        CC.SEX_CD   = 'FEMALE'
              left outer join
              TI_EORG_BASE D
              on       A.EORG_LOC_NO = D.LOC_NO
              left outer join
              TS_LOC_INFO_BASE DDD
              on       HI.NEAR_LOC_NO = DDD.LOC_NO
              left outer join
              TS_STDT_STRS_HIST F
              on		 A.STDT_NO   = F.STDT_NO
              left outer join
              TS_STDT_DGEM_HIST H
              on	     A.STDT_NO   = H.STDT_NO
              and        A.DGEM_HIST_SEQ = H.DGEM_HIST_SEQ
              left outer join
              TI_DGEM_STND E
              on		 H.ACT_DIV_CD   = E.ACT_DIV_CD
              and        H.HBIT_STAT_CD = E.HBIT_STAT_CD
              and        H.DGEM_STAT_CD = E.DGEM_STAT_CD
              and        H.PLC_CLSS_CD  = E.PLC_CLSS_CD
              and        H.TEMP_STAT_CD = E.TEMP_STAT_CD
              left outer join
              TS_GFIX_HIST G
              on  	 A.STDT_NO     = G.STDT_NO
              left outer join
              TS_BAND_INFO I
              on		 A.BAND_ID     = I.BAND_ID
              left outer join
              TS_STDT_CBEE_HIST K
              on		 A.CBEE_HIST_NO = K.CBEE_HIST_NO
              and        A.STDT_NO      = K.STDT_NO
              where      1=1
       <if test="entrDtFr != null and entrDtFr != null and entrDtTo !='' and entrDtTo !='' ">
        and B.ENTR_DT between #{entrDtFr} and #{entrDtTo}</if>
        <if test=" stdtNo != null and stdtNo !='' ">
        and      A.STDT_NO     = #{stdtNo}::numeric</if>
        <if test=" stdtNm != null and stdtNm !='' ">
        and      A.STDT_NM     like concat('%',#{stdtNm},'%')</if>
        <if test=" telNo != null and telNo !='' ">
        and      I.TEL_NO      like concat('%',#{telNo},'%')</if>
        <if test=" bandId != null and bandId !='' ">
        and      I.BAND_ID     like concat('%',#{bandId},'%')</if>
        <if test=" guarNo != null and guarNo !='' ">
        and      B.GUAR_NO     = #{guarNo}::numeric</if>
        <if test=" guarTelNo != null and guarTelNo !='' ">
        and      B.GUAR_TEL_NO like concat('%',#{guarTelNo},'%')</if>
        <if test=" locNm != null and locNm !='' ">
        and      D.LOC_NM      like concat('%',#{locNm},'%')</if>
        <if test=' paging == "Y" '>
        LIMIT ${rowCount} OFFSET ${currentIndex}
        </if>
        </select>
</mapper>
