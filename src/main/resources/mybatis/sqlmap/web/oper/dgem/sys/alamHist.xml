<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.sys.alamHist">
    <!-- 위험감정 발생이력 조회 -->
    <select id="searchAlamHistList" parameterType="java.util.Map" resultType="MybatisMap">
        select TAH.SEND_DTTM    /*발생일시*/
        ,TAH.GUAR_NO	    /*보호자번호*/
        ,DECR(TGB.GUAR_NM) AS GUAR_NM      /*보호자명*/
        ,DECR(TGB.GUAR_TEL_NO) AS GUAR_TEL_NO  /*보호자전화번호*/
        ,TSB.STDT_NO      /*학생번호*/
        ,DECR(TSB.STDT_NM) AS STDT_NM      /*학생명*/
        ,TAH.ALAM_CHNL_CD /*채널종류*/
        ,TAH.ALAM_TYPE_CD /*알림유형*/
        ,TAH.ALAM_TITL    /*알림제목*/
        ,case when TAH.SEND_RSLT_CD = '00' then '성공'   /*발송여부*/
        when TAH.SEND_RSLT_CD = '01' then '미발송'
        when TAH.SEND_RSLT_CD = '11' then 'key없음'
        when TAH.SEND_RSLT_CD = '99' then '발송 실패(기타)'
        end  as SEND_RSLT_CD
        from   TS_ALAM_HIST TAH
        left   outer join
        TM_STDT_BASE TSB
        on     TAH.STDT_NO = TSB.STDT_NO
        left   outer join
        TM_GUAR_BASE TGB
        on     TGB.GUAR_NO = TAH.GUAR_NO
        where  1=1
        <if test="entrDtFr != null and entrDtFr != null and entrDtTo !='' and entrDtTo !='' ">
        and    TAH.SEND_DTTM between #{entrDtFr} and #{entrDtTo}</if>
        <if test=" alamChnlCd != null and alamChnlCd !='' ">
        and    TAH.ALAM_CHNL_CD    = #{alamChnlCd}</if>
        <if test=" alamTypeCd != null and alamTypeCd !='' ">
        and    TAH.ALAM_TYPE_CD    = #{alamTypeCd}</if>
        <if test=" sendRsltCd != null and sendRsltCd !='' ">
        and    TAH.SEND_RSLT_CD    = #{sendRsltCd}</if>
        <if test=" guarNo != null and guarNo !='' ">
        and    TAH.GUAR_NO         = #{guarNo}::numeric</if>
        <if test=" guarNm != null and guarNm !='' ">
        and    DECR(TGB.GUAR_NM)   = #{guarNm}</if>
    <if test=' paging == "Y" '>
    LIMIT ${rowCount} OFFSET ${currentIndex}
    </if>
    </select>

</mapper>
