<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.dgem.dgemHist">
    <!-- 위험감정 발생이력 조회 -->
    <select id="searchDgemHistList" parameterType="java.util.Map" resultType="MybatisMap">
    select  A.STDT_NO		 /* 학생번호 */
    ,A.DGEM_HIST_SEQ  /* 위험감정 이력 순번 */
    ,A.DGEM_DT        /* 위험감정 일자 */
    ,A.DGEM_TM        /* 위험감정 시각 */
    ,A.DGEM_IDX       /* 위험감정 지수 */
    ,A.DGEM_STAT_CD   /* 위험감정 상태 코드 */
    ,A.DGEM_STAT_CNTN /* 위험감정 요약 내용 */
    ,A.DGEM_SMRY_CNTN /* 위험감정 상태 내용 */
    ,A.LOC_HIST_NO    /* 위치 이력 번호 */
    ,A.CURR_LAT_VAL   /* 현재 위도 값 */
    ,A.CURR_LON_VAL   /* 현재 경도 값 */
    ,A.LOC_MESU_DTTM  /* 위치 측정 일시 */
    ,A.ACT_DIV_CD     /* 활동 구분 코드 */
    ,A.HBIT_STAT_CD   /* 심박 상태 코드 */
    ,A.PLC_CLSS_CD    /* 장소 분류 코드 */
    ,A.TEMP_STAT_CD   /* 체온 상태 코드 */
    ,A.JUDG_NO        /* 판정 번호 */
    ,A.RMRK			 /* 비고 */
    ,A.DGEM_ALAM_NO   /* 위험감정 알림 번호 */
    ,D.LOC_NM	     /* 학교명 */
    ,F.GUAR_NO 		 /* 보호자번호 */
    ,F.GUAR_NM		 /* 보호자명 */
    ,F.GUAR_TEL_NO    /* 보호자전화번호 */
    ,fn_getCdNm('EVNT_DIV_CD',B.evnt_div_cd) as evnt_div_nm /* 이벤트 구분 명 */
    from    TS_STDT_DGEM_HIST A
    left    outer join
    TD_JUDG_BASE B
    on      A.JUDG_NO = B.JUDG_NO
    left    outer join
    TM_STDT_BASE C
    on      A.STDT_NO = C.STDT_NO
    left    outer join
    TI_EORG_BASE D
    on      C.LOC_HIST_NO = D.LOC_NO
    left    outer join
    TM_STDT_GUAR_CONN E
    on      C.STDT_NO = E.STDT_NO
    left    outer join
    TM_GUAR_BASE F
    on      E.GUAR_NO = F.GUAR_NO
    where   1=1
    and     fn_getCdNm('EVNT_DIV_CD',B.evnt_div_cd) in('정기판정셋','이벤트판정셋')
        <if test=" dgemDt != null and dgemDt !='' ">
    and     DGEM_DT        like CONCAT ('%',#{dgemDt},'%')     /* 위험감정 일자 */</if>
        <if test=" dgemTm != null and dgemTm !='' ">
    and     DGEM_TM        like CONCAT ('%',#{dgemTm},'%')     /* 위험감정 시각 */</if>
        <if test=" dgemStatCd != null and dgemStatCd !='' ">
    and     DGEM_STAT_CD   like CONCAT ('%',#{dgemStatCd},'%') /* 위험감정 상태 */</if>
        <if test=" plcClssCd != null and plcClssCd !='' ">
    and     PLC_CLSS_CD    like CONCAT ('%',#{plcClssCd},'%')  /* 장소분류 코드 */</if>
        <if test=" hbitStatCd != null and hbitStatCd !='' ">
    and     A.HBIT_STAT_CD like CONCAT ('%',#{hbitStatCd},'%') /* 심박상태 코드 */</if>
        <if test=" tempStatCd != null and tempStatCd !='' ">
    and     TEMP_STAT_CD   like CONCAT ('%',#{tempStatCd},'%') /* 체온상태 코드 */</if>
        <if test=" locNm != null and locNm !='' ">
    and     D.LOC_NM       like CONCAT ('%',#{locNm},'%')      /* 학교명       */</if>
        <if test=" stdtNo != null and stdtNo !='' ">
    and     C.STDT_NO      = #{stdtNo}::numeric                /* 학생번호     */</if>
        <if test=" stdtNm != null and stdtNm !='' ">
    and     C.STDT_NM      like CONCAT ('%',#{stdtNm},'%')     /* 학생명       */</if>
        <if test=" guarNo != null and guarNo !='' ">
    and     F.GUAR_NO      = #{guarNo}::numeric                /* 보호자번호    */</if>
        <if test=" guarNm != null and guarNm !='' ">
    and     F.GUAR_NM      like CONCAT ('%',#{guarNm},'%')     /* 보호자명     */</if>
    ORDER BY A.STDT_NO
    <if test=' paging == "Y" '>
    LIMIT ${rowCount} OFFSET ${currentIndex}
    </if>
    </select>

    <!--학생정보 및 보호자 정보 select-->
    <select id="searchStdtGuarList" parameterType="java.util.Map" resultType="MybatisMap">
        select A.STDT_NO
        ,A.STDT_NM
        ,C.GUAR_NO
        ,C.GUAR_NM
        ,C.GUAR_TEL_NO
        from   TM_STDT_BASE A
        left outer join
        TM_STDT_GUAR_CONN B
        on     A.STDT_NO = B.STDT_NO
        left outer join
        TM_GUAR_BASE C
        on     B.GUAR_NO = C.GUAR_NO
        where  1=1
        <if test=" stdtNo != null and stdtNo !='' ">
        and    A.STDT_NO = #{stdtNo}::numeric</if>
        <if test=" stdtNm != null and stdtNm !='' ">
        and    A.STDT_NM = #{stdtNm}</if>
        <if test=" guarNo != null and guarNo !='' ">
        and    C.GUAR_NO = #{guarNo}::numeric</if>
        <if test=" guarNm != null and guarNm !='' ">
        and    C.GUAR_NM = #{guarNm}</if>
        group  by A.STDT_NO , A.STDT_NM , C.GUAR_NO , C.GUAR_NM
        order  by A.stdt_no
    </select>

   <!--학생정보 insert -->
   <insert id="insertTmStdtBase"  parameterType="java.util.Map" >
   <selectKey keyProperty="stdtNo" resultType="int" order="BEFORE">
       select nextval('tm_stdt_base_seq')
   </selectKey>
   /* insertTmStdtBase */
   INSERT INTO tm_stdt_base
   (
        stdt_no /* stdt_no 학생_번호 numeric */
       ,stdt_nm /* stdt_nm 학생_명 character varying(40) */
       ,band_id /* band_id 밴드_ID character varying(20) */
       ,eorg_loc_no /* eorg_loc_no 교육시설_위치_번호 numeric */
       ,sgrd_cd /* sgrd_cd 학년_코드 character varying(20) */
       ,sex_cd /* sex_cd 성별_코드 character varying(20) */
       ,bith_dt /* bith_dt 생일_일자 character(8) */
       ,race_div_cd /* race_div_cd 인종_구분_코드 character varying(20) */
       ,grow_mesu_dt
       ,prnt_no
       ,reg_dt /* reg_dt 등록_일자 character(8) */
       ,reg_tm /* reg_tm 등록_시각 character(6) */
       ,reg_user_id /* reg_user_id 등록_사용자_ID character varying(20) */
       ,upt_dt /* upt_dt 수정_일자 character(8) */
       ,upt_tm /* upt_tm 수정_시각 character(6) */
       ,upt_user_id /* upt_user_id 수정_사용자_ID character varying(20) */
   )
   VALUES
   (
        #{stdtNo}  /* stdt_no 학생_번호 numeric */
       ,#{stdtNm} /* stdt_nm 학생_명 character varying(40) */
       ,#{bandId} /* band_id 밴드_ID character varying(20) */
       ,${eorgLocNo} /* eorg_loc_no 교육시설_위치_번호 numeric */
       ,#{sgrdCd} /* sgrd_cd 학년_코드 character varying(20) */
       ,#{sexCd} /* sex_cd 성별_코드 character varying(20) */
       ,replace(#{bithDt} , '-' , '') /* bith_dt 생일_일자 character(8) */
       ,#{raceDivCd} /* race_div_cd 인종_구분_코드 character varying(20) */
       ,TO_CHAR(NOW(), 'YYYYMMDD')
       ,#{prntNo}
       ,TO_CHAR(NOW(), 'YYYYMMDD') /* reg_dt 등록_일자 character(8) */
       ,TO_CHAR(NOW(), 'HH24MISS') /* reg_tm 등록_시각 character(6) */
       ,#{regUserId} /* reg_user_id 등록_사용자_ID character varying(20) */
       ,TO_CHAR(NOW(), 'YYYYMMDD') /* upt_dt 수정_일자 character(8) */
       ,TO_CHAR(NOW(), 'HH24MISS') /* upt_tm 수정_시각 character(6) */
       ,#{uptUserId} /* upt_user_id 수정_사용자_ID character varying(20) */
   )
   </insert>

    <!--학생정보 insert -->
    <insert id="insertTsStdtGrowHist"  parameterType="java.util.Map" >
       /* insertTsStdtGrowHist */
       INSERT INTO ts_stdt_grow_hist
       (
            stdt_no /* stdt_no 학생_번호 numeric */
           ,mesu_dt
           ,hght_unit_cd
           ,hght_val
           ,wght_unit_cd
           ,wght_val
           ,wast_unit_cd
           ,wast_val
           ,reg_dt /* reg_dt 등록_일자 character(8) */
           ,reg_tm /* reg_tm 등록_시각 character(6) */
           ,reg_user_id /* reg_user_id 등록_사용자_ID character varying(20) */
           ,upt_dt /* upt_dt 수정_일자 character(8) */
           ,upt_tm /* upt_tm 수정_시각 character(6) */
           ,upt_user_id /* upt_user_id 수정_사용자_ID character varying(20) */
       )
       VALUES
       (
            #{stdtNo}
           ,TO_CHAR(NOW(), 'YYYYMMDD')
           ,'CM'
           ,${hghtVal}
           ,'KG'
           ,${wghtVal}
           ,'INCH'
           ,${wastVal}
           ,TO_CHAR(NOW(), 'YYYYMMDD') /* reg_dt 등록_일자 character(8) */
           ,TO_CHAR(NOW(), 'HH24MISS') /* reg_tm 등록_시각 character(6) */
           ,#{regUserId} /* reg_user_id 등록_사용자_ID character varying(20) */
           ,TO_CHAR(NOW(), 'YYYYMMDD') /* upt_dt 수정_일자 character(8) */
           ,TO_CHAR(NOW(), 'HH24MISS') /* upt_tm 수정_시각 character(6) */
           ,#{uptUserId} /* upt_user_id 수정_사용자_ID character varying(20) */
       )
   </insert>

    <insert id="insertTsDdHbitHist"  parameterType="java.util.Map" >
       /* insertTsDdHbitHist */
       insert into ts_dd_hbit_hist
       (
             stdt_no
            ,stnd_dt
            ,vald_yn
            ,bot_blck_val
            ,down_blck_val
            ,uppr_blck_val
            ,top_blck_val
            ,reg_dt /* reg_dt 등록_일자 character(8) */
            ,reg_tm /* reg_tm 등록_시각 character(6) */
            ,reg_user_id /* reg_user_id 등록_사용자_ID character varying(20) */
            ,upt_dt /* upt_dt 수정_일자 character(8) */
            ,upt_tm /* upt_tm 수정_시각 character(6) */
            ,upt_user_id /* upt_user_id 수정_사용자_ID character varying(20) */
       )
       select
             ${stdtNo}                                                         as stdt_no
            ,to_char(now(), 'YYYYMMDD')                                        as stnd_dt
            ,'N'                                                               as vald_yn
            ,max(case when hbit_stat_cd = 'LOW'   then hbit_cnt_fr else 0 end) as bot_blck_val
            ,max(case when hbit_stat_cd = 'NORM'  then hbit_cnt_fr else 0 end) as down_blck_val
            ,max(case when hbit_stat_cd = 'HIGH'  then hbit_cnt_fr else 0 end) as uppr_blck_val
            ,max(case when hbit_stat_cd = 'VHIGH' then hbit_cnt_fr else 0 end) as top_blck_val
            ,to_char(now(), 'YYYYMMDD') /* reg_dt 등록_일자 character(8) */
            ,to_char(now(), 'HH24MISS') /* reg_tm 등록_시각 character(6) */
            ,#{regUserId} /* reg_user_id 등록_사용자_ID character varying(20) */
            ,to_char(now(), 'YYYYMMDD') /* upt_dt 수정_일자 character(8) */
            ,to_char(now(), 'HH24MISS') /* upt_tm 수정_시각 character(6) */
            ,#{uptUserId} /* upt_user_id 수정_사용자_ID character varying(20) */
       from   ti_hbit_stat_stnd a
       where  1 = 1
       and    hbit_stat_cd != 'VLOW'
       and    exists(select 1
                      from   tm_stdt_base
                      where  1 = 1
                      and    a.sex_cd   = sex_cd
                      and    a.age_ycnt = fn_getAge(bith_dt)
                      and    stdt_no    = ${stdtNo})
    </insert>



   <!--학생정보 update -->
   <update id="updateTmStdtBase"  parameterType="java.util.Map" >
          /* updateTiGrowJudgStnd */
          UPDATE tm_stdt_base
          <trim prefix="SET" prefixOverrides=",">
            <if test="stdtNm != null">
                ,stdt_nm = #{stdtNm}
            </if>
            <if test="bandId != null">
                ,band_id = #{bandId}
            </if>
            <if test="eorgLocNo != null">
                ,eorg_loc_no = cast(#{eorgLocNo} as integer)
            </if>
            <if test="sgrdCd != null">
                ,sgrd_cd = #{sgrdCd}
            </if>
            <if test="sexCd != null">
                ,sex_cd = #{sexCd}
            </if>
            <if test="bithDt != null">
                ,bith_dt = #{bithDt}
            </if>
            <if test="raceDivCd != null">
                ,race_div_cd = #{raceDivCd}
            </if>
            ,upt_dt = TO_CHAR(NOW(), 'YYYYMMDD') /* upt_dt 수정_일자 character(8) */
            ,upt_tm = TO_CHAR(NOW(), 'HH24MISS')  /* upt_tm 수정_시각 character(6) */
            ,upt_user_id = #{uptUserId} /* upt_user_id 수정_사용자_ID character varying(20) */
          </trim>
          WHERE  1 = 1
          AND    stdt_no = #{stdtNo}
   </update>

    <!--학생정보 update -->
    <update id="updateTsStdtGrowHist"  parameterType="java.util.Map" >
        /* updateTsStdtGrowHist */
        UPDATE ts_stdt_grow_hist
        <trim prefix="SET" prefixOverrides=",">
            <if test="hghtVal != null">
                ,hght_val = #{hghtVal}
            </if>
            <if test="wghtVal != null">
                ,wght_val = #{wghtVal}
            </if>
            <if test="wastVal != null">
                ,wast_val = #{wastVal}
            </if>
            ,upt_dt = TO_CHAR(NOW(), 'YYYYMMDD') /* upt_dt 수정_일자 character(8) */
            ,upt_tm = TO_CHAR(NOW(), 'HH24MISS')  /* upt_tm 수정_시각 character(6) */
            ,upt_user_id = #{uptUserId} /* upt_user_id 수정_사용자_ID character varying(20) */
        </trim>
        WHERE  1 = 1
        AND    stdt_no = #{stdtNo}
        AND    mesu_dt = #{growMesuDt}
    </update>

   <!--학생정보 delete -->
   <delete id="deleteTmStdtBase"  parameterType="java.util.Map" >
    /* deleteTmStdtBase */
    update FROM tm_stdt_base
    set del_yn ='Y'
       ,del_dt = TO_CHAR(NOW(), 'YYYYMMDD')
    WHERE  1 = 1
    AND    stdt_no = #{stdtNo} /* grow_judg_cd 성장_판정_코드 character varying(20) */
   </delete>

    <select id="searchStdtDetlInfo" parameterType="java.util.Map" resultType="MybatisMap">
    with stdt_info as (
          select
                tsb.stdt_no
               ,tsb.stdt_nm
               ,tsgc.guar_no
               ,tsb.band_id
               ,tsb.eorg_loc_no
               ,(select loc_nm from ti_eorg_base where loc_no = tsb.eorg_loc_no limit 1) as eorg_loc_nm
               ,tsb.sgrd_cd
               ,fn_getcdnm('SGRD_CD',tsb.sgrd_cd) as sgrd_nm
               ,tsb.sex_cd
               ,fn_getcdnm('SEX_CD' ,tsb.sex_cd) as sex_nm
               ,tsb.bith_dt
               ,tsb.race_div_cd
               ,fn_getcdnm('RACE_DIV_CD' ,tsb.race_div_cd) as race_div_nm
               ,tsb.band_stat_cd
               ,fn_getcdnm('BAND_STAT_CD' ,tsb.band_stat_cd) as band_stat_nm
               ,to_char(to_timestamp(tsb.band_comm_dttm , 'YYYYMMDDhh24miss') , 'YYYY-MM-DD hh24:mi:ss') as band_comm_dttm
               ,tsb.band_chrg_qty
               ,tsb.grow_mesu_dt
               ,tsb.dact_judg_no
               ,tsb.dgem_hist_seq
               ,tsb.strs_hist_seq
               ,tsb.loc_hist_no
               ,tsb.cbee_hist_no
               ,tsb.gfix_dt
               ,tgb.guar_nm
               ,tgb.guar_tel_no
               ,tsgh.hght_val
               ,tsgh.wght_val
               ,tsgh.wast_val
               ,tgb.prnt_no
         from tm_stdt_base tsb                 /* 학생 */
         inner join tm_stdt_guar_conn tsgc
           on tsb.stdt_no = tsgc.stdt_no
         inner join tm_guar_base tgb           /* 보호자 */
           on tsgc.guar_no = tgb.guar_no
         left outer join ts_stdt_grow_hist tsgh /*학생 성장기록*/
           on tsb.stdt_no  = tsgh.stdt_no
          and tsb.grow_mesu_dt  = tsgh.mesu_dt
         where tsb.stdt_no = #{stdtNo}::numeric
          and  tgb.guar_no = #{guarNo}::numeric
    )
    , prnt_info as (
        select prnt_no
              ,max(prnt_male) as prnt_male
              ,max(prnt_female) as prnt_female
        from
            (
            select
                 tpb.prnt_no
                 ,case when tpb.sex_cd = 'MALE' then tpb.prnt_nm else '' end as prnt_male
                 ,case when tpb.sex_cd = 'FEMALE' then tpb.prnt_nm else '' end as prnt_female
            from stdt_info stdt
            inner join tm_prnt_base tpb
            on stdt.prnt_no = tpb.prnt_no
            ) as prnt
        group by prnt_no
    )
    , loc_list as (
      /* 위치 */
         select
               tslh.stdt_no
              ,tslh.loc_hist_no
              ,tslh.plc_clss_cd
              ,fn_getcdnm('PLC_CLSS_CD'               ,tslh.plc_clss_cd) as plc_clss_nm
              ,tlib.loc_nm
              ,tslh.lat_val
              ,tslh.lon_val
              ,to_char(to_timestamp(tslh.occr_dttm  , 'YYYYMMDDhh24miss') , 'YYYY-MM-DD hh24:mi:ss') as occr_dttm
        from ts_stdt_loc_hist tslh
        inner join stdt_info stdt
           on tslh.stdt_no = stdt.stdt_no
          and tslh.loc_hist_no = stdt.loc_hist_no
        inner join ts_loc_info_base tlib
           on tslh.near_loc_no = tlib.loc_no
    )
    , grow_stat_list as (
    /* 위험감정 */
         select
              tsdh.stdt_no
             ,tsdh.dgem_hist_seq
             ,tds.dgem_smry_cntn
             ,tds.dgem_stat_cntn
             ,tslh.plc_clss_cd
             ,fn_getcdnm('PLC_CLSS_CD' ,tslh.plc_clss_cd) as plc_clss_nm
             ,tlib.loc_nm
             ,tlib.plc_cd
             ,fn_getcdnm('PLC_CD' , tlib.plc_cd) as plc_nm
             ,tjb.hbit_mdan
             ,tsdh.hbit_stat_cd
             ,fn_getcdnm('HBIT_STAT_CD' , tsdh.hbit_stat_cd) as hbit_stat_nm
             ,tjb.temp_val
             ,fn_getcdnm('TEMP_STAT_CD' , tsdh.temp_stat_cd) as temp_stat_nm
             ,to_char(to_timestamp(tsdh.loc_mesu_dttm  , 'YYYYMMDDhh24miss') , 'YYYY-MM-DD hh24:mi:ss') as loc_mesu_dttm
             ,tsdh.dgem_idx
             ,tsdh.dgem_stat_cd
             ,fn_getcdnm('DGEM_STAT_CD' , tsdh.dgem_stat_cd) as dgem_stat_nm
         from ts_stdt_dgem_hist tsdh      /* 학생위험상태 */
         inner join stdt_info stdt
           on tsdh.stdt_no = stdt.stdt_no
          and tsdh.dgem_hist_seq = stdt.dgem_hist_seq
         inner join ti_dgem_stnd tds
           on tsdh.act_div_cd = tds.act_div_cd
          and tsdh.hbit_stat_cd = tds.hbit_stat_cd
          and tsdh.plc_clss_cd = tds.plc_clss_cd
          and tsdh.temp_stat_cd = tds.temp_stat_cd
         inner join ts_stdt_loc_hist tslh
           on  tsdh.stdt_no = tslh.stdt_no
          and tsdh.loc_hist_no = tslh.loc_hist_no
         inner join ts_loc_info_base tlib
           on tslh.near_loc_no = tlib.loc_no
         inner join td_judg_base tjb
           on tsdh.judg_no = tjb.judg_no
    )
   , gfix_list as (
    /* 성장,비만지수 */
        select
              tgh.stdt_no
             ,tgh.gfix_dt
             ,tgh.grow_idx
             ,tgh.grow_judg_cd
             ,fn_getcdnm('GROW_JUDG_CD' , tgh.grow_judg_cd) as grow_judg_nm
             ,tgh.fat_idx
             ,tgjs.smry_cntn
             ,tgjs.spec_cntn
             ,fn_getcdnm('FAT_JUDG_CD' , tgh.fat_judg_cd) as fat_judg_nm
             ,tfjs.curr_eval_cntn
             ,fn_getcdnm('FAT_JUDG_CD' , tgh.prdt_fat_judg_cd) as prdt_fat_judg_nm
             ,tgh.cal_eat_qty
             ,tgh.cal_csum_qty
             ,tgh.pal_val
             ,tgh.cal_nutr_stat_cd
             ,fn_getcdnm('NUTR_STAT_CD' , tgh.cal_nutr_stat_cd) as cal_nutr_stat_nm
             ,to_char(to_timestamp(tgh.upt_dt||tgh.upt_tm ,'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS') as gfix_upt_dttm
        from ts_gfix_hist tgh /* 성장이력 */
        inner join stdt_info stdt
           on tgh.stdt_no = tgh.stdt_no
          and tgh.gfix_dt = stdt.gfix_dt
        inner join ti_grow_judg_stnd tgjs
           on tgh.grow_judg_cd = tgjs.grow_judg_cd
        inner join ti_fat_judg_stnd tfjs
           on tgh.fat_judg_cd = tfjs.fat_judg_cd
    )
    , strs_list as (
    /* 스트레스 */
        select
              tssh.stdt_no
             ,tssh.strs_hist_seq
             ,tssh.hbit_mdan  as strt_hbit_mdan
             ,tssh.avg_hbit_cnt
             ,tssh.ment_strs_pnt
             ,tssh.ment_strs_stat_cd
             ,fn_getcdnm('STRS_STAT_CD' , tssh.ment_strs_stat_cd) as ment_strs_stat_nm
             ,tssh.phys_strs_pnt
             ,tssh.phys_strs_stat_cd
             ,fn_getcdnm('STRS_STAT_CD' , tssh.phys_strs_stat_cd) as phys_strs_stat_nm
             ,tssh.strs_cope_pnt
             ,tssh.strs_cope_stat_cd
             ,fn_getcdnm('STRS_COPE_STAT_CD' , tssh.strs_cope_stat_cd) as strs_cope_stat_nm
             ,to_char(to_timestamp(tssh.upt_dt||tssh.upt_tm ,'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS') as strs_upt_dttm
        from ts_stdt_strs_hist tssh
        inner join stdt_info stdt
           on tssh.stdt_no = stdt.stdt_no
        and tssh.strs_hist_seq = stdt.strs_hist_seq
    )
    select
          stdt.*
         ,tbi.band_id
         ,tbi.tel_no  as band_tel_no
         ,loc.plc_clss_cd
         ,loc.plc_clss_nm
         ,loc.loc_nm
         ,loc.lat_val
         ,loc.lon_val
         ,loc.lat_val || ' / ' || loc.lon_val as lat_lon_val
         ,loc.occr_dttm
         ,grow.dgem_smry_cntn
         ,grow.dgem_stat_cntn
         ,grow.plc_clss_cd as grow_plc_clss_cd
         ,grow.plc_clss_nm as grow_plc_clss_nm
         ,grow.loc_nm as grow_loc_nm
         ,grow.plc_cd
         ,grow.plc_nm
         ,grow.hbit_mdan
         ,grow.hbit_stat_cd
         ,grow.hbit_stat_nm
         ,grow.temp_val
         ,grow.dgem_idx
         ,grow.temp_stat_nm
         ,grow.dgem_stat_cd
         ,grow.dgem_stat_nm
         ,grow.loc_mesu_dttm
         ,gfix.grow_idx
         ,gfix.grow_judg_cd
         ,gfix.grow_judg_nm
         ,gfix.smry_cntn
         ,gfix.spec_cntn
         ,gfix.fat_idx
         ,gfix.fat_judg_nm
         ,gfix.curr_eval_cntn
         ,gfix.prdt_fat_judg_nm
         ,strs.avg_hbit_cnt
         ,strs.ment_strs_pnt
         ,strs.ment_strs_stat_cd
         ,strs.ment_strs_stat_nm
         ,strs.phys_strs_pnt
         ,strs.phys_strs_stat_cd
         ,strs.phys_strs_stat_nm
         ,strs.strs_cope_pnt
         ,strs.strs_cope_stat_cd
         ,strs.strs_cope_stat_nm
         ,strs.strs_upt_dttm
         ,prnt.prnt_female
         ,prnt.prnt_male
         ,gfix.cal_eat_qty
         ,gfix.cal_csum_qty
         ,gfix.pal_val
         ,gfix.cal_nutr_stat_cd
         ,gfix.cal_nutr_stat_nm
         ,gfix.gfix_upt_dttm
    from stdt_info stdt
    inner join prnt_info prnt
      on stdt.prnt_no = prnt.prnt_no
    inner join  ts_band_info tbi
      on stdt.band_id = tbi.band_id
    left outer join loc_list loc
      on stdt.stdt_no = loc.stdt_no
    left outer join grow_stat_list grow
      on stdt.stdt_no = grow.stdt_no
    left outer join gfix_list gfix
      on stdt.stdt_no = gfix.stdt_no
    left outer join strs_list strs
      on stdt.stdt_no = strs.stdt_no
    </select>

    <select id="searchBandGuarTelNo" parameterType="java.util.Map" resultType="MybatisMap">
        select
             count(tgb.guar_no) as guar_no_cnt
            ,count(distinct tpb.prnt_no) as prnt_no_cnt
            ,max(tpb.prnt_no) as prnt_no
        from ts_band_spec tbs
        inner join tm_guar_base tgb
          on tbs.guar_tel_no = tgb.guar_tel_no
        left outer join tm_prnt_base tpb
          on tgb.prnt_no = tpb.prnt_no
        where tbs.band_id = #{bandId}
    </select>


    <insert id="insertTmStdtGuarConn" parameterType="java.util.Map">
        insert into tm_stdt_guar_conn
        (
             stdt_no
            ,guar_no
            ,reg_dt
            ,reg_tm
            ,reg_user_id
            ,upt_dt
            ,upt_tm
            ,upt_user_id
        )
        select c.stdt_no
              ,d.guar_no
              ,to_char(now(), 'YYYYMMDD')
              ,to_char(now(), 'HH24MISS')
              ,#{regUserId}
              ,to_char(now(), 'YYYYMMDD')
              ,to_char(now(), 'HH24MISS')
              ,#{uptUserId}
        from   ts_band_info a
        inner join ts_band_spec b
        on  b.band_id = a.band_id
        inner join tm_stdt_base c
        on  c.band_id = a.band_id
        inner join tm_guar_base d
        on  d.guar_tel_no = b.guar_tel_no
        where  1 = 1
        and    c.stdt_no = ${stdtNo}
        and    not exists(select 1
                          from   tm_stdt_guar_conn
                          where  stdt_no = c.stdt_no
                          and    guar_no = d.guar_no)
    </insert>

    <select id="searchStdtEorgLocList" parameterType="java.util.Map" resultType="MybatisMap">
        select
             loc_no
            ,loc_nm
            ,road_addr
        from ti_eorg_base teb
        where 1=1
        <if test="locNm != null and locNm !='' ">
            and loc_nm like '%' || #{locNm} || '%'
        </if>
        <if test="roadAddr != null and roadAddr !='' ">
            and road_addr like '%' || #{roadAddr} || '%'
        </if>
    </select>

    <select id="searchBandList" parameterType="java.util.Map" resultType="MybatisMap">
        select
             band_id
            ,tel_no
            ,band_open_stat_cd
            ,fn_getCdNm('BAND_OPEN_STAT_CD', band_open_stat_cd) AS band_open_stat_nm
        from ts_band_info tbi
        where not exists (select 1 from tm_stdt_base tsb where tsb.band_id = tbi.band_id and tsb.del_yn = 'N')
        <if test="bandId != null and bandId !='' ">
            and band_id like '%' || #{bandId} || '%'
        </if>
        <if test="telNo != null and telNo !='' ">
            and tel_no like '%' || #{telNo} || '%'
        </if>
        <if test="bandOpenStatCd != null and bandOpenStatCd !='' ">
            and band_open_stat_cd = #{bandOpenStatCd}
        </if>
    </select>


</mapper>
