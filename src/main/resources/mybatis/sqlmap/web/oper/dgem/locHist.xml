<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.dgem.locHist">
    <!-- 위험감정 발생이력 조회 -->
    <select id="searchLocHistList" parameterType="java.util.Map" resultType="MybatisMap">
        select  TSLH.OCCR_DTTM /* 발생일시 */
        ,TLIB.LOC_NM as SCHL_NM/* 학교명 */
        ,TSLH.STDT_NO/* 학생번호 */
        ,DECR(TSB.STDT_NM) as STDT_NM/* 학생명 */
        ,TSLH.LOC_NM/* 장소 */
        ,TSLH.PLC_CLSS_CD/* 장소분류 */
        ,TLIB.LAT_VAL/* 위도 */
        ,TLIB.LON_VAL/* 경도 */
        ,TLIB.LOC_NM as NEAR_LOC_NM/* 위치명 */
        ,COALESCE(TLIB.ADDR_BASE,TSLH.LOC_NM) as ADDR_BASE/* 주소 */
        ,DECR(TBI.TEL_NO) as TEL_NO/* 학생전번 */
        ,TGB.GUAR_NO as GUAR_NO/* 보호지번호 */
        ,DECR(TGB.GUAR_NM) as GUAR_NM/* 보호자명 */
        ,DECR(TGB.GUAR_TEL_NO) as GUAR_TEL_NO/* 보호자전번 */
        from   TS_STDT_LOC_HIST TSLH
        inner join
        TS_LOC_INFO_BASE TLIB
        on     TSLH.near_loc_no = TLIB.LOC_NO
        left   outer join
        TM_STDT_BASE TSB
        on     TSB.STDT_NO = TSLH.STDT_NO
        left   outer join
        TM_STDT_GUAR_CONN TSGC
        on     TSB.STDT_NO = TSGC.STDT_NO
        left   outer join
        TM_GUAR_BASE TGB
        on     TSGC.GUAR_NO = TGB.GUAR_NO
        left   outer join
        TS_BAND_INFO TBI
        on     TSB.BAND_ID = TBI.BAND_ID
        WHERE    1=1
    <if test="entrDtFr != null and entrDtFr != null and entrDtTo !='' and entrDtTo !='' ">
    and     TSLH.OCCR_DTTM between replace(#{entrDtFr},'-','') and replace(#{entrDtTo},'-','')        /* 위험감정 일자 */</if>
    <if test=" plcClssCd != null and plcClssCd !='' ">
    and     TSLH.PLC_CLSS_CD    like CONCAT ('%',#{plcClssCd},'%')  /* 장소분류 코드 */</if>
    <if test=" locNm != null and locNm !='' ">
    and     TEB.LOC_NM       like CONCAT ('%',#{locNm},'%')      /* 학교명       */</if>
    <if test=" stdtNo != null and stdtNo !='' ">
    and     TSLH.STDT_NO      = #{stdtNo}::numeric                /* 학생번호     */</if>
    <if test=" stdtNm != null and stdtNm !='' ">
    and     DECR(TSB.STDT_NM)      like CONCAT ('%',#{stdtNm},'%')     /* 학생명       */</if>
    <if test=" guarNo != null and guarNo !='' ">
    and     TGB.GUAR_NO      = #{guarNo}::numeric                /* 보호자번호    */</if>
    <if test=" guarNm != null and guarNm !='' ">
    and     DECR(TGB.GUAR_NM)      like CONCAT ('%',#{guarNm},'%')     /* 보호자명     */</if>
    <if test=' paging == "Y" '>
    LIMIT ${rowCount} OFFSET ${currentIndex}
    </if>
    </select>
</mapper>
