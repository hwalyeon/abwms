<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.dgem.locHist">
    <!-- 위험감정 발생이력 조회 -->
    <select id="searchLocHistList" parameterType="java.util.Map" resultType="MybatisMap">
    select TSLH.OCCR_DTTM
    ,TEB.LOC_NM as SCHL_NM
    ,TSLH.STDT_NO
    ,DECR(TSB.STDT_NM) AS STDT_NM
    ,TSLH.LOC_NM
    ,TSLH.PLC_CLSS_CD
    ,TSLH.LAT_VAL
    ,TSLH.LON_VAL
    ,TSLH.NEAR_LOC_NO
    ,TLIB.ADDR_BASE
    ,DECR(TBI.TEL_NO) AS TEL_NO
    ,TGB.GUAR_NO
    ,DECR(TGB.GUAR_NM) AS GUAR_NM
    ,DECR(TBS.GUAR_TEL_NO) AS GUAR_TEL_NO
    ,TSLH.REG_DT
    ,TSLH.REG_TM
    ,TSLH.REG_USER_ID
    ,TSLH.UPT_DT
    ,TSLH.UPT_TM
    ,TSLH.UPT_USER_ID
    from   TS_STDT_LOC_HIST TSLH
    left   outer join
    TM_STDT_BASE TSB
    on     TSLH.LOC_HIST_NO = TSB.LOC_HIST_NO
    and    TSLH.STDT_NO     = TSB.STDT_NO
    left   outer join
    TS_LOC_INFO_BASE TLIB
    on     TLIB.LOC_NO      = TSLH.LOC_HIST_NO
    left   outer join
    TI_EORG_BASE TEB
    on     TEB.LOC_NO       = TSB.EORG_LOC_NO
    left   outer join
    TS_BAND_INFO TBI
    on     TBI.BAND_ID      = TSB.BAND_ID
    left   outer join
    TS_BAND_SPEC TBS
    on     TBI.BAND_ID      = TBS.BAND_ID
    left   outer join
    TM_STDT_GUAR_CONN TSGC
    on     TSB.STDT_NO      = TSGC.STDT_NO
    inner  join
    TM_GUAR_BASE TGB
    on     TSGC.GUAR_NO     = TGB.GUAR_NO
    and    TGB.GUAR_TEL_NO  = TBS.GUAR_TEL_NO
    where  1=1
    <if test="entrDtFr != null and entrDtFr != null and entrDtTo !='' and entrDtTo !='' ">
    and     TSLH.OCCR_DTTM between #{entrDtFr} and #{entrDtTo}        /* 위험감정 일자 */</if>
    <if test=" plcClssCd != null and plcClssCd !='' ">
    and     TSLH.PLC_CLSS_CD    like CONCAT ('%',#{plcClssCd},'%')  /* 장소분류 코드 */</if>
    <if test=" locNm != null and locNm !='' ">
    and     TEB.LOC_NM       like CONCAT ('%',#{schlNm},'%')      /* 학교명       */</if>
    <if test=" stdtNo != null and stdtNo !='' ">
    and     TSLH.STDT_NO      = #{stdtNo}::numeric                /* 학생번호     */</if>
    <if test=" stdtNm != null and stdtNm !='' ">
    and     DECR(TSB.STDT_NM)      like CONCAT ('%',#{stdtNm},'%')     /* 학생명       */</if>
    <if test=" guarNo != null and guarNo !='' ">
    and     TGB.GUAR_NO      = #{guarNo}::numeric                /* 보호자번호    */</if>
    <if test=" guarNm != null and guarNm !='' ">
    and     DECR(TGB.GUAR_NM)      like CONCAT ('%',#{guarNm},'%')     /* 보호자명     */</if>
    <if test=' paging == "Y" '>
    LIMIT ${rowCount} OFFSET ${currentIndex}
    </if>
    </select>
</mapper>
