<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.dgem.locHist">
    <!-- 위험감정 발생이력 조회 -->
    <select id="searchLocHistList" parameterType="java.util.Map" resultType="MybatisMap">
    select TSLH.OCCR_DTTM
    ,TEB.LOC_NM as SCHL_NM
    ,TSLH.STDT_NO
    ,DECR(TSB.STDT_NM) AS STDT_NM
    ,TSLH.LOC_NM
    ,TSLH.PLC_CLSS_CD
    ,TSLH.LAT_VAL
    ,TSLH.LON_VAL
    ,TSLH.NEAR_LOC_NO
    ,TLIB.ADDR_BASE
    ,DECR(TBI.TEL_NO) AS TEL_NO
    ,TGB.GUAR_NO
    ,DECR(TGB.GUAR_NM) AS GUAR_NM
    ,DECR(TBS.GUAR_TEL_NO) AS GUAR_TEL_NO
    ,TSLH.REG_DT
    ,TSLH.REG_TM
    ,TSLH.REG_USER_ID
    ,TSLH.UPT_DT
    ,TSLH.UPT_TM
    ,TSLH.UPT_USER_ID
    from   TS_STDT_LOC_HIST TSLH
    left   outer join
    TM_STDT_BASE TSB
    on     TSLH.LOC_HIST_NO = TSB.LOC_HIST_NO
    and    TSLH.STDT_NO     = TSB.STDT_NO
    left   outer join
    TS_LOC_INFO_BASE TLIB
    on     TLIB.LOC_NO      = TSLH.LOC_HIST_NO
    left   outer join
    TI_EORG_BASE TEB
    on     TEB.LOC_NO       = TSB.EORG_LOC_NO
    left   outer join
    TS_BAND_INFO TBI
    on     TBI.BAND_ID      = TSB.BAND_ID
    left   outer join
    TS_BAND_SPEC TBS
    on     TBI.BAND_ID      = TBS.BAND_ID
    left   outer join
    TM_STDT_GUAR_CONN TSGC
    on     TSB.STDT_NO      = TSGC.STDT_NO
    inner  join
    TM_GUAR_BASE TGB
    on     TSGC.GUAR_NO     = TGB.GUAR_NO
    and    TGB.GUAR_TEL_NO  = TBS.GUAR_TEL_NO
    where  1=1
    <if test="entrDtFr != null and entrDtFr != null and entrDtTo !='' and entrDtTo !='' ">
    and     TSLH.OCCR_DTTM between #{entrDtFr} and #{entrDtTo}        /* 위험감정 일자 */</if>
    <if test=" plcClssCd != null and plcClssCd !='' ">
    and     TSLH.PLC_CLSS_CD    like CONCAT ('%',#{plcClssCd},'%')  /* 장소분류 코드 */</if>
    <if test=" locNm != null and locNm !='' ">
    and     TEB.LOC_NM       like CONCAT ('%',#{schlNm},'%')      /* 학교명       */</if>
    <if test=" stdtNo != null and stdtNo !='' ">
    and     TSLH.STDT_NO      = #{stdtNo}::numeric                /* 학생번호     */</if>
    <if test=" stdtNm != null and stdtNm !='' ">
    and     DECR(TSB.STDT_NM)      like CONCAT ('%',#{stdtNm},'%')     /* 학생명       */</if>
    <if test=" guarNo != null and guarNo !='' ">
    and     TGB.GUAR_NO      = #{guarNo}::numeric                /* 보호자번호    */</if>
    <if test=" guarNm != null and guarNm !='' ">
    and     DECR(TGB.GUAR_NM)      like CONCAT ('%',#{guarNm},'%')     /* 보호자명     */</if>
    <if test=' paging == "Y" '>
    LIMIT ${rowCount} OFFSET ${currentIndex}
    </if>
    </select>

    <!--학생정보 및 보호자 정보 select-->
    <select id="searchStdtGuarList" parameterType="java.util.Map" resultType="MybatisMap">
        select A.STDT_NO
        ,DECR(A.STDT_NM) AS STDT_NM
        ,C.GUAR_NO
        ,DECR(C.GUAR_NM) AS GUAR_NM
        ,DECR(C.GUAR_TEL_NO) AS GUAR_TEL_NO
        from   TM_STDT_BASE A
        left outer join
        TM_STDT_GUAR_CONN B
        on     A.STDT_NO = B.STDT_NO
        left outer join
        TM_GUAR_BASE C
        on     B.GUAR_NO = C.GUAR_NO
        where  1=1
        <if test=" stdtNo != null and stdtNo !='' ">
        and    A.STDT_NO = #{stdtNo}::numeric</if>
        <if test=" stdtNm != null and stdtNm !='' ">
        and    A.STDT_NM = ENCR(#{stdtNm})</if>
        <if test=" guarNo != null and guarNo !='' ">
        and    C.GUAR_NO = #{guarNo}::numeric</if>
        <if test=" guarNm != null and guarNm !='' ">
        and    C.GUAR_NM = ENCR(#{guarNm})</if>
        <if test=" guarTelNo != null and guarTelNo !='' ">
        and    C.GUAR_TEL_NO = ENCR(#{guarTelNo})</if>
        group  by A.STDT_NO , A.STDT_NM , C.GUAR_NO , C.GUAR_NM
        order  by A.stdt_no
        <if test=' paging == "Y" '>
            LIMIT ${rowCount} OFFSET ${currentIndex}
        </if>
    </select>

    <!--학교정보 select-->
    <select id="searchLocList" parameterType="java.util.Map" resultType="MybatisMap">
        select TEB.LOC_NO
	          ,TEB.LOC_NM
	          ,TEB.ROAD_ADDR
        from   TI_EORG_BASE TEB
        left   outer join
	           TM_STDT_BASE TSB
        on     TSB.EORG_LOC_NO = TEB.LOC_NO
        where  1=1
        <if test="wordHead1 != null and wordHead1 !=''">
        and    SPLIT_PART(TEB.ROAD_ADDR, ' ', 1) = #{wordHead1} </if>
        <if test="wordHead2 != null and wordHead2 !=''">
        and    SPLIT_PART(TEB.ROAD_ADDR, ' ', 2) = #{wordHead2} </if>
        <if test="locNm     != null and locNm     !=''">
        and    TEB.LOC_NM like CONCAT ('%',#{locNm},'%')        </if>
        order  by TEB.LOC_NO
        <if test=' paging == "Y" '>
            LIMIT ${rowCount} OFFSET ${currentIndex}
        </if>
    </select>

</mapper>
