<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.hc.guarFmenuHist">

    <!--보호자_식단표_현황 리스트 조회-->
	<select id="selectGuarFmenuHistList" parameterType="java.util.Map" resultType="MybatisMap">
		select tfb.guar_no         as guar_no    /* guar_no   보호자_번호 numeric */
		     , DECR(tgb.guar_nm)   as guar_nm    /* guar_nm   보호자_명   character varying(40) */
		     , tfb.fmenu_seq       as fmenu_seq  /* fmenu_seq 식단표_순번 numeric */
		     , tfb.fmenu_nm        as fmenu_nm   /* fmenu_nm  식단표_명   character varying(100) */
		     , tfb.mmel_yn         as mmel_yn    /* mmel_yn   아침_여부   character(1) */
		     , tfb.amel_yn         as amel_yn    /* amel_yn   점심_여부   character(1) */
		     , tfb.emel_yn         as emel_yn    /* emel_yn   저녁_여부   character(1) */
		     , tfb.smel_yn         as smel_yn    /* smel_yn   간식_여부   character(1) */
		     , tdeh.feq_use        as feq_use    /*이용 빈도(수)*/
		from   ts_fmenu_base tfb                --식단표_기본 tfb
		inner join      TM_GUAR_BASE tgb            --보호자_기본 tgb
		                on tfb.GUAR_NO = tgb.GUAR_NO
		left outer join ( select   count(FMENU_SEQ) as feq_use
								  , guar_no
							  	  , fmenu_seq
						  from      TS_DD_EAT_HIST
						  group by  guar_no,fmenu_seq
						) tdeh                   --일별_섭취_이력 tdeh
		                on tfb.GUAR_NO = tdeh.GUAR_NO
		and    tfb.FMENU_SEQ = tdeh.FMENU_SEQ
		WHERE  1 = 1
		<if test=" fmenuNm != null and fmenuNm !='' ">/*식단표_명*/
			and tfb.fmenu_nm like CONCAT('%',#{fmenuNm},'%')</if>
		<if test="(mmelYn != null and mmelYn !='') or (amelYn != null and amelYn !='') or (emelYn != null and emelYn !='')  or (smelYn != null and smelYn !='') ">/*아침,점심,저녁,간식_여부*/
		    and
		    (
			<trim prefixOverrides="OR">
		    	<if test ='mmelYn == "Y"'>
					OR tfb.mmel_yn = #{mmelYn}
				</if>
				<if test ='amelYn == "Y"'>
					OR	tfb.amel_yn = #{amelYn}
				</if>
				<if test ='emelYn == "Y"'>
					OR	tfb.emel_yn = #{emelYn}
				</if>
				<if test ='smelYn == "Y"'>
					OR	tfb.smel_yn = #{smelYn}
				</if>
			</trim>
			)
		</if>
		<if test=" guarNo != null and guarNo !='' ">/*보호자_번호*/
			and tfb.guar_no = #{guarNo}::NUMERIC </if>
		<if test=" guarNm != null and guarNm !='' ">/*보호자_명*/
			and tgb.guar_nm = ENCR(#{guarNm})</if>
        <if test=' paging == "Y" '>
		LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
</mapper>