<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oper.hc.eatHist">

    <!--섭취_이력 리스트 조회-->
	<select id="selectEatHistList" parameterType="java.util.Map" resultType="MybatisMap">
		select *from
		(select  tdeh.stnd_dt          /* stnd_dt 기준_일자 character(8) */
		       , teb.loc_nm            /* loc_nm  학교_명   varchar(100) */
		       , tdeh.stdt_no          /* stdt_no 학생_번호 numeric      */
		       , tsb.stdt_nm           /* stdt_nm 학생_명   varchar(40)  */
		       , max(case when tfb.mmel_yn = 'Y' then 'Y' else 'N' end)  as mmel_yn  /* mmel_fmenu_yn 아침_여부 char*/
		       , max(case when tfb.mmel_yn = 'Y' then tfb.fmenu_seq end) as mmel_fmenu_seq /* fmenu_seq 아침_식단표_순번 numeric                */
		       , max(case when tfb.mmel_yn = 'Y' then tfb.fmenu_nm  end) as mmel_fmenu_nm  /* fmenu_nm  아침_식단표_명   character varying(100) */
		       , max(case when tfb.amel_yn = 'Y' then tfb.fmenu_seq end) as amel_fmenu_seq /* fmenu_seq 점심_식단표_순번 numeric                */
		       , max(case when tfb.amel_yn = 'Y' then tfb.fmenu_nm  end) as amel_fmenu_nm  /* fmenu_nm  점심_식단표_명   character varying(100) */
		       , max(case when tfb.emel_yn = 'Y' then tfb.fmenu_seq end) as emel_fmenu_seq /* fmenu_seq 저녁_식단표_순번 numeric                */
		       , max(case when tfb.emel_yn = 'Y' then tfb.fmenu_nm  end) as emel_fmenu_nm  /* fmenu_nm  저녁_식단표_명   character varying(100) */
		       , max(case when tfb.smel_yn = 'Y' then tfb.fmenu_seq end) as smel_fmenu_seq /* fmenu_seq 간식_식단표_순번 numeric                */
		       , max(case when tfb.smel_yn = 'Y' then tfb.fmenu_nm  end) as smel_fmenu_nm  /* fmenu_nm  간식_식단표_명   character varying(100) */
		       , tbi.tel_no            /* tel_no      전화_번호       character varying(20)  */
		       , tdeh.guar_no          /* guar_no     보호자_번호     numeric                */
		       , tgb.guar_nm           /* guar_nm     보호자_명       character varying(40)  */
		       , tgb.guar_tel_no       /* guar_tel_no 보호자_전화_번호 character varying(20) */
		from     ts_dd_eat_hist tdeh
		         inner join TS_FMENU_BASE tfb               --식단표_기본 tsb
		                 on tdeh.guar_no   = tfb.guar_no
		                and tdeh.fmenu_seq = tfb.fmenu_seq
		         inner join TM_STDT_BASE tsb                --학생_기본 tsb
		                 on tdeh.stdt_no = tsb.stdt_no
		         inner join TI_EORG_BASE teb                --교육기관_기본 teb
		                 on tsb.eorg_loc_no = teb.loc_no
		         inner join TS_BAND_INFO tbi                --밴드_정보 tbi
		                 on tsb.band_id = tbi.band_id
		         inner join TM_GUAR_BASE tgb                --보호자_기본 tgb
		                 on tdeh.guar_no = tgb.guar_no
		where    1=1
		<if test="stndDtFr != null and stndDtFr != null and stndDtTo !='' and stndDtTo !='' ">
			and tdeh.stnd_dt between replace(#{stndDtFr},'-','') and replace(#{stndDtTo},'-','')</if> /*기준 일자*/
		<if test=" stdtNo != null and stdtNo !='' ">
			and tdeh.stdt_no = #{stdtNo}::NUMERIC </if>                          /*학생_번호*/
		<if test=" stdtNm != null and stdtNm !='' ">
			and tdeh.stdt_nm like CONCAT('%',#{stdtNm},'%')</if>                 /*학생_명*/
		<if test=" fmenuNm != null and fmenuNm !='' ">
			and tfb.fmenu_nm like CONCAT('%',#{fmenuNm},'%')</if>                /*식단표_명*/
		<if test=" guarNo != null and guarNo !='' ">
		and tdeh.guar_no = #{guarNo}::NUMERIC </if>                              /*보호자_번호*/
		<if test=" guarNm != null and guarNm !='' ">
			and tsb.guar_NM like CONCAT('%',#{guarNm},'%')</if>                  /*보호자_명*/
		<if test=" locNm != null and locNm !='' ">
			and tsb.LOC_NM like CONCAT('%',#{locNm},'%')</if>                    /*학교_명*/
		group by tdeh.stnd_dt, teb.loc_nm , tdeh.stdt_no, tsb.stdt_nm, tdeh.guar_no, tbi.tel_no , tgb.guar_nm  , tgb.guar_tel_no
		) fmenuData
		where 1=1
		<if test=" mmelYn != null and mmelYn !='' or amelYn != null and amelYn !='' or emelYn != null and emelYn !=''  or smelYn != null and smelYn !='' ">/*아침,점심,저녁,간식_식사_여부*/
		and fmenuData.mmel_yn = #{mmelYn} or fmenuData.amel_yn = #{amelYn} or fmenuData.emel_yn = #{emelYn} or fmenuData.smel_yn = #{smelYn}</if>
		<if test=" mmelStarvYn != null and mmelStarvYn !=''">
		and fmenuData.mmel_yn = #{mmelStarvYn}</if>                                /*아침_결식_여부*/
		group by fmenuData.stnd_dt, fmenuData.loc_nm , fmenuData.stdt_no, fmenuData.stdt_nm, fmenuData.guar_no, fmenuData.tel_no , fmenuData.guar_nm  , fmenuData.guar_tel_no
		<if test=' paging == "Y" '>
		LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
</mapper>