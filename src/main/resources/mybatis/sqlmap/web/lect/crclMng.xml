<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lect.crclMng">

	<select id="selectTsCousLect" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT B.ACDM_ID
	      ,(SELECT ACDM_NM
	        FROM   TO_ACDM_BASE
	        WHERE  ACDM_ID = B.ACDM_ID)               AS ACDM_NM
	      ,A.COUS_NO
	      ,A.LECT_SEQ
	      ,B.COUS_NM
	      ,A.LECT_NM
	      ,A.LECT_METH_CD
	      ,FN_CD_NM('LECT_METH_CD', A.LECT_METH_CD)   AS LECT_METH_NM
	      ,B.LCTR_ID
	      ,(SELECT LCTR_NM
	        FROM   TO_LCTR_BASE
	        WHERE  LCTR_ID = B.LCTR_ID)               AS LCTR_NM
	      ,A.LECT_STRT_DTTM
	      ,DATE_FORMAT(A.LECT_STRT_DTTM, '%Y%m%d')    AS LECT_STRT_DT
	      ,DATE_FORMAT(A.LECT_STRT_DTTM, '%H%i%s')    AS LECT_STRT_TM
	      ,A.LECT_END_DTTM
	      ,DATE_FORMAT(A.LECT_END_DTTM , '%Y%m%d')    AS LECT_END_DT
	      ,DATE_FORMAT(A.LECT_END_DTTM , '%H%i%s')    AS LECT_END_TM
	      ,A.LECT_TCNT
	      ,A.LECT_URL
	      ,A.HWORK_TYPE_CD
	      ,FN_CD_NM('HWORK_TYPE_CD', A.HWORK_TYPE_CD) AS HWORK_TYPE_NM
	      ,B.COUS_STAT_CD
	FROM   TS_COUS_LECT A
	       INNER JOIN TS_COUS_BASE B
	       ON  B.COUS_NO = A.COUS_NO
    WHERE  1 = 1
<if test=" acdmId != null and acdmId != '' ">
    AND    B.ACDM_ID = #{acdmId}					</if>
<if test=" lctrId != null and lctrId != '' ">
    AND    B.LCTR_ID = #{lctrId}					</if>
<if test=" stdtId != null and stdtId != '' ">
    AND    EXISTS (SELECT 1
                   FROM   TS_COUS_STDT
                   WHERE  COUS_NO = A.COUS_NO
                   AND    STDT_ID = #{stdtId})					</if>
<if test=" cousNo != null and cousNo != '' ">
    AND    A.COUS_NO = #{cousNo}					</if>
<if test=" lectSeq != null and lectSeq != '' ">
    AND    A.LECT_SEQ = #{lectSeq}					</if>
<if test=" lectNm != null and lectNm != '' " >
    AND    A.LECT_NM LIKE CONCAT('%', #{lectNm}, '%')	</if>
<if test=" lectMethCd != null and lectMethCd != '' " >
    AND    A.LECT_METH_CD = #{lectMethCd}			</if>
<if test=" lectDt != null and lectDt != '' " >
    AND    A.LECT_STRT_DTTM LIKE CONCAT(#{lectDt}, '%')	</if>
	ORDER BY A.COUS_NO, A.LECT_SEQ, A.LECT_STRT_DTTM
<if test=' paging == "Y" '>
	LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
	
	<select id="selectLectSeq" parameterType="java.util.Map" resultType="int">
	SELECT CASE WHEN MAX(LECT_SEQ) IS NULL THEN 1
	            ELSE CAST(MAX(LECT_SEQ) AS UNSIGNED) + 1
	       END AS LECT_SEQ
	FROM   TS_COUS_LECT
    WHERE  COUS_NO = #{cousNo}
	</select>
	
	<insert id="insertTsCousLect" parameterType="java.util.Map">
    INSERT INTO TS_COUS_LECT
	(
	    COUS_NO
	   ,LECT_SEQ
	   ,LECT_NM
	<if test=" lectMethCd != null and lectMethCd != '' ">
	   ,LECT_METH_CD			</if>
	<if test=" lectStrtDttm != null and lectStrtDttm != '' ">
	   ,LECT_STRT_DTTM				</if>
	<if test=" lectEndDttm != null and lectEndDttm != '' ">
	   ,LECT_END_DTTM				</if>
	<if test=" lectTcnt != null and lectTcnt != '' ">
	   ,LECT_TCNT		</if>
	<if test=" lectUrl != null and lectUrl != '' ">
	   ,LECT_URL			</if>
	<if test=" hworkUrl != null and hworkUrl != '' ">
	   ,HWORK_URL		</if>
	<if test=" hworkTypeCd != null and hworkTypeCd != '' ">
	   ,HWORK_TYPE_CD		</if>   
	   ,REG_DT
	   ,REG_TM
	   ,REG_USER_ID
	   ,UPT_DT
	   ,UPT_TM
	   ,UPT_USER_ID
	)
	VALUES
	(
	    #{cousNo}
	   ,#{lectSeq}
	   ,#{lectNm}
	<if test=" lectMethCd != null and lectMethCd != '' ">
	   ,#{lectMethCd}			</if>
	<if test=" lectStrtDttm != null and lectStrtDttm != '' ">
	   ,#{lectStrtDttm}				</if>
	<if test=" lectEndDttm != null and lectEndDttm != '' ">
	   ,#{lectEndDttm}				</if>
	<if test=" lectTcnt != null and lectTcnt != '' ">
	   ,#{lectTcnt}		</if>
	<if test=" lectUrl != null and lectUrl != '' ">
	   ,#{lectUrl}			</if>
	<if test=" hworkUrl != null and hworkUrl != '' ">
	   ,#{hworkUrl}         </if>
	<if test=" hworkTypeCd != null and hworkTypeCd != '' ">
	   ,#{hworkTypeCd}		</if>      
       ,DATE_FORMAT(NOW(), '%Y%m%d')
       ,DATE_FORMAT(NOW(), '%H%i%s')
       ,#{regUserId}
       ,DATE_FORMAT(NOW(), '%Y%m%d')
       ,DATE_FORMAT(NOW(), '%H%i%s')
       ,#{uptUserId}
    )
	</insert>
	
	<update id="updateTsCousLect" parameterType="java.util.Map">
	UPDATE TS_COUS_LECT
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	<if test=" lectNm != null and lectNm != '' ">
	      ,LECT_NM      = #{lectNm}				</if>
	<if test=" lectMethCd != null and lectMethCd != '' ">
	      ,LECT_METH_CD = #{lectMethCd}			</if>
	<if test=" lectStrtDttm != null and lectStrtDttm != '' ">
	      ,LECT_STRT_DTTM = #{lectStrtDttm}		</if>
	<if test=" lectEndDttm != null and lectEndDttm != '' ">
	      ,LECT_END_DTTM = #{lectEndDttm}		</if>
	<if test=" lectTcnt != null and lectTcnt != '' ">
	      ,LECT_TCNT     = #{lectTcnt}			</if>
	<if test=" lectUrl != null and lectUrl != '' ">
	      ,LECT_URL      = #{lectUrl}			</if>
	<if test=" hworkUrl != null and hworkUrl != '' ">
	      ,HWORK_URL     = #{hworkUrl} 			</if>
	<if test=" hworkTypeCd != null and hworkTypeCd != '' ">
	      ,HWORK_TYPE_CD = #{hworkTypeCd}		</if>        
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</update>
		
	<delete id="deleteTsCousLect" parameterType="java.util.Map">
	DELETE 
	FROM   TS_COUS_LECT
	WHERE  COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</delete>
	
	<select id="selectTsCousHworkBase" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT 
		 A.COUS_NO
		,B.COUS_NM 
		,A.LECT_SEQ 
		,A.LECT_NM
		,A.HWORK_TYPE_CD 
		,C.HWORK_NM 
		,C.HWORK_DESC 
		,(SELECT MAX(SEQ) FROM TS_COUS_HWORK_DETL WHERE COUS_NO = C.COUS_NO AND LECT_SEQ = C.LECT_SEQ ) AS HWORK_CNT
	FROM TS_COUS_LECT A
	INNER JOIN TS_COUS_BASE B
	ON B.COUS_NO  = A.COUS_NO
	LEFT OUTER JOIN TS_COUS_HWORK_BASE C
	ON C.COUS_NO = A.COUS_NO
	AND C.LECT_SEQ = A.LECT_SEQ
	WHERE  A.COUS_NO  = #{cousNo}
	AND    A.LECT_SEQ = #{lectSeq}
	</select>
	
	<insert id="insertTsCousHworkBase" parameterType="java.util.Map">
	INSERT INTO TS_COUS_HWORK_BASE(
	      COUS_NO
		, LECT_SEQ
		, HWORK_NM
		, HWORK_DESC
		, REG_DT
		, REG_TM
		, REG_USER_ID
		, UPT_DT
		, UPT_TM
		, UPT_USER_ID
	) VALUES(
	      #{cousNo}
		, #{lectSeq}
		, #{hworkNm}
		, #{hworkDesc}
	    , DATE_FORMAT(NOW(), '%Y%m%d')
	    , DATE_FORMAT(NOW(), '%H%i%s')
	    , #{regUserId}
	    , DATE_FORMAT(NOW(), '%Y%m%d')
	    , DATE_FORMAT(NOW(), '%H%i%s')
	    , #{uptUserId}
	)
	</insert>
	
	<update id="updateTsCousHworkBase" parameterType="java.util.Map">
	UPDATE TS_COUS_HWORK_BASE
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	<if test=" hworkNm != null and hworkNm != '' ">
	      ,HWORK_NM     = #{hworkNm}				</if>
	<if test=" hworkDesc != null and hworkDesc != '' ">
	      ,HWORK_DESC = #{hworkDesc}			</if>
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</update>
	
	<delete id="deleteTsCousHworkBase" parameterType="java.util.Map">
	DELETE 
	FROM  TS_COUS_HWORK_BASE
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</delete>
	
	<update id="mergeTsCousHworkDetl" parameterType="java.util.Map" >		
	INSERT INTO TS_COUS_HWORK_DETL (
	  COUS_NO
	, LECT_SEQ
	, SEQ 
    , REG_DT
	, REG_TM
	, REG_USER_ID
	, UPT_DT
	, UPT_TM
	, UPT_USER_ID
	) VALUES (
	  #{cousNo}
	, #{lectSeq}
	, #{seq}  
	, DATE_FORMAT(NOW(), '%Y%m%d')
    , DATE_FORMAT(NOW(), '%H%i%s')
    , #{regUserId}
    , DATE_FORMAT(NOW(), '%Y%m%d')
    , DATE_FORMAT(NOW(), '%H%i%s')
    , #{uptUserId}
	)
	ON
		DUPLICATE KEY
	UPDATE
	  UPT_USER_ID = #{uptUserId}
	, UPT_DT = DATE_FORMAT(NOW(), '%Y%m%d')
	, UPT_TM = DATE_FORMAT(NOW(), '%H%i%s')
	</update>
	
	<delete id="deleteTsCousHworkDetl" parameterType="java.util.Map">
	DELETE 
	FROM  TS_COUS_HWORK_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    SEQ > #{hworkCnt}
	</delete>
	
	<delete id="deleteAllTsCousHworkDetl" parameterType="java.util.Map">
	DELETE 
	FROM  TS_COUS_HWORK_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</delete>
	
	<select id="selectTsCousHworkDetl" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT 
		 A.COUS_NO
		,A.LECT_SEQ
		,A.SEQ 
		,A.QUST_TYPE_CD
		,FN_CD_NM('QUST_TYPE_CD', A.QUST_TYPE_CD) AS QUST_TYPE_NM
		,A.QUST_CNTN
		,A.ITEM_CNTN 
		,A.CORT_CNTN
		,A.APNT_VAL	
	FROM TS_COUS_HWORK_DETL A
	WHERE A.COUS_NO = #{cousNo}
	AND   A.LECT_SEQ = #{lectSeq}
	<if test=" seq != null and seq != '' ">
	AND   A.SEQ = #{seq}	
	</if>
	</select>
	
	<update id="updateTsCousHworkDetl" parameterType="java.util.Map" >
	UPDATE TS_COUS_HWORK_DETL
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	<if test=" qustTypeCd != null and qustTypeCd != '' ">
	      ,QUST_TYPE_CD = #{qustTypeCd}				</if>
	<if test=" qustCntn != null and qustCntn != '' ">
	      ,QUST_CNTN    = #{qustCntn}			</if>
	<if test=" itemCntn != null and itemCntn != '' ">
	      ,ITEM_CNTN    = #{itemCntn}			</if>
	<if test=" cortCntn != null and cortCntn != '' ">
	      ,CORT_CNTN    = #{cortCntn}			</if>
	<if test=" apntVal != null and apntVal != '' ">
	      ,APNT_VAL = #{apntVal}			</if>                       
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    SEQ = #{seq}
	</update>
	
	
	<update id="updateDelTsCousHworkDetl" parameterType="java.util.Map" >
	UPDATE TS_COUS_HWORK_DETL
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	      ,QUST_TYPE_CD = null
	      ,QUST_CNTN    = null
	      ,ITEM_CNTN    = null	
	      ,CORT_CNTN    = null
	      ,APNT_VAL     = null                       
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    SEQ = #{seq}
	</update>
	

</mapper>