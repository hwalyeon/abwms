<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lect.hworkEvalMng">
	
	<select id="searchHworkEvalList" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT B.ACDM_ID
	      ,(SELECT ACDM_NM
	        FROM   TO_ACDM_BASE
	        WHERE  ACDM_ID = B.ACDM_ID)               AS ACDM_NM
	      ,A.COUS_NO
	      ,A.LECT_SEQ
	      ,B.COUS_NM
	      ,A.LECT_NM
	      ,B.LCTR_ID
	      ,C.LCTR_NM
	      ,E.STDT_ID 
	      ,E.STDT_NM 
	      ,A.LECT_STRT_DTTM
	      ,DATE_FORMAT(A.LECT_STRT_DTTM, '%Y%m%d')    AS LECT_STRT_DT
	      ,DATE_FORMAT(A.LECT_STRT_DTTM, '%H%i%s')    AS LECT_STRT_TM
	      ,A.LECT_END_DTTM
	      ,DATE_FORMAT(A.LECT_END_DTTM , '%Y%m%d')    AS LECT_END_DT
	      ,DATE_FORMAT(A.LECT_END_DTTM , '%H%i%s')    AS LECT_END_TM
	      ,A.LECT_TCNT
	      ,A.LECT_URL
	      ,A.HWORK_TYPE_CD
	      ,FN_CD_NM('HWORK_TYPE_CD', A.HWORK_TYPE_CD) AS HWORK_TYPE_NM
	      ,D.HWORK_SBMT_DTTM 
	      ,CASE WHEN D.EVAL_YN IS NULL THEN 'N' ELSE D.EVAL_YN END AS EVAL_YN
	      ,D.HWORK_EVAL_SCOR
	      ,A.UPT_USER_ID
	FROM   TS_COUS_LECT A
	       INNER JOIN TS_COUS_BASE B
	       ON  B.COUS_NO = A.COUS_NO
	       INNER JOIN TO_LCTR_BASE C
	       ON  C.LCTR_ID = B.LCTR_ID
	       INNER JOIN TS_COUS_TAKE_DETL D
	       ON  D.COUS_NO  = A.COUS_NO
	       AND D.LECT_SEQ = A.LECT_SEQ
	       INNER JOIN TO_STDT_BASE E
           ON  D.STDT_ID = E.STDT_ID
    WHERE  1 = 1
    <if test=' cousNo != null and cousNo != "" '>
    AND  A.COUS_NO  = #{cousNo} </if>
    <if test=' lectSeq != null and lectSeq != "" '>
	AND    A.LECT_SEQ = #{lectSeq} </if>
    AND    A.HWORK_TYPE_CD != '00'
	ORDER BY A.COUS_NO, A.LECT_SEQ, A.LECT_STRT_DTTM
	<if test=' paging == "Y" '>
	LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
	
	<update id="updateTsCousTakeDetl" parameterType="java.util.Map">
	UPDATE TS_COUS_TAKE_DETL
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	      ,EVAL_YN      = 'Y'
	<if test=" hworkEvalScor != null and hworkEvalScor != '' ">
	      ,HWORK_EVAL_SCOR     = #{hworkEvalScor}				</if>
	<if test=" totEvalOpin != null and totEvalOpin != '' ">
	      ,TOT_EVAL_OPIN = #{totEvalOpin}			</if>
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    STDT_ID  = #{stdtId}
	</update>
	
	<update id="updateTsHworkSolvDetl" parameterType="java.util.Map">
	UPDATE TS_HWORK_SOLV_DETL
	SET    EVAL_SCOR      = #{evalScor}
	      ,EVAL_OPIN      = #{evalOpin}
		  ,UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID     = #{uptUserId}
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    STDT_ID  = #{stdtId}
	AND    SEQ      = #{seq}
	</update>
	
	<update id="updateAutoTsHworkSolvDetl" parameterType="java.util.Map">
	UPDATE TS_HWORK_SOLV_DETL X
	SET EVAL_SCOR = COALESCE( (SELECT A.APNT_VAL FROM TS_COUS_HWORK_DETL A WHERE A.COUS_NO = X.COUS_NO AND A.LECT_SEQ = X.LECT_SEQ AND A.SEQ = X.SEQ AND A.CORT_CNTN = X.ANSWER_CNTN) , 0)
	   ,UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
       ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	WHERE  1 = 1
	AND    X.COUS_NO  = #{cousNo}
	AND    X.LECT_SEQ = #{lectSeq}
	AND    X.STDT_ID  = #{stdtId}
	</update>
	
	<update id="updateAutoTsCousTakeDetl" parameterType="java.util.Map">
	UPDATE TS_COUS_TAKE_DETL X
	SET HWORK_EVAL_SCOR = COALESCE((SELECT SUM(A.EVAL_SCOR) FROM TS_HWORK_SOLV_DETL A WHERE A.COUS_NO = X.COUS_NO AND A.LECT_SEQ = X.LECT_SEQ AND A.STDT_ID = X.STDT_ID) , 0)
	   ,UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
       ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	WHERE  1 = 1
	AND    X.COUS_NO  = #{cousNo}
	AND    X.LECT_SEQ = #{lectSeq}
	AND    X.STDT_ID  = #{stdtId}
	</update>
	
	<update id="updateSaveEvalEnd" parameterType="java.util.Map">
	UPDATE TS_COUS_TAKE_DETL X
	SET TOT_EVAL_OPIN   = #{totEvalOpin}
	   ,EVAL_YN         = 'Y'
	   ,UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
       ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	WHERE  1 = 1
	AND    X.COUS_NO  = #{cousNo}
	AND    X.LECT_SEQ = #{lectSeq}
	AND    X.STDT_ID  = #{stdtId}
	</update>
	


</mapper>