<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lect.lectMng">

	<select id="selectLectTakeObj" resultType="mybatisMap">
	
	SELECT A.COUS_NO
	      ,B.LECT_SEQ
	      ,B.LECT_STRT_DTTM
	      ,B.LECT_END_DTTM
	      ,(SELECT COUNT(1)
	        FROM   TS_COUS_TAKE_DETL
	        WHERE  COUS_NO  = B.COUS_NO
	        AND    LECT_SEQ = B.LECT_SEQ) AS COUS_TAKE_REG_CNT
	FROM   TS_COUS_BASE A
	       INNER JOIN TS_COUS_LECT B
	       ON  B.COUS_NO = A.COUS_NO
	WHERE  COUS_STAT_CD = '10'
	AND    DATE_FORMAT(NOW(), '%Y%m%d') BETWEEN COUS_STRT_DT AND COUS_END_DT
	AND    DATE_FORMAT(NOW(), '%Y%m%d') BETWEEN DATE_FORMAT(LECT_STRT_DTTM, '%Y%m%d') AND DATE_FORMAT(LECT_END_DTTM, '%Y%m%d')
	
	</select>

	<insert id="insertTsCousTakeDetl" parameterType="java.util.Map">

	INSERT INTO TS_COUS_TAKE_DETL
	(
		 COUS_NO
		,LECT_SEQ
		,STDT_ID
		,ATND_YN
		,SWCH_YN
		,RWAY_YN
		,TAKE_TCNT
		,EVAL_YN
		,HWORK_EVAL_SCOR
		,REG_DT
		,REG_TM
		,REG_USER_ID
		,UPT_DT
		,UPT_TM
		,UPT_USER_ID
	)
	SELECT  A.COUS_NO
	       ,#{lectSeq}
	       ,A.STDT_ID
	       ,'N'
	       ,'N'
	       ,'N'
	       ,0
	       ,'N'
	       ,0
	       ,DATE_FORMAT(NOW(), '%Y%m%d')
	       ,DATE_FORMAT(NOW(), '%H%i%s')
	       ,#{regUserId}
	       ,DATE_FORMAT(NOW(), '%Y%m%d')
	       ,DATE_FORMAT(NOW(), '%H%i%s')
	       ,#{uptUserId}
	FROM    TS_COUS_STDT A
	WHERE   1 = 1
	AND     COUS_NO           = #{cousNo}
	AND     COUS_STDT_STAT_CD = '20' 
	
	</insert>
	
	<update id="updateChangeCousStdtStat">
	UPDATE TS_COUS_STDT A
	SET    COUS_STDT_STAT_CD = '20'
	WHERE  1 = 1
	AND    COUS_STDT_STAT_CD = '10'
	AND    EXISTS (SELECT 1
                   FROM   TS_COUS_BASE
                   WHERE  COUS_NO = A.COUS_NO
                   AND    COUS_STAT_CD = '20')
	</update>
	
	<update id="updateChangeCousStat">
	UPDATE TS_COUS_BASE
	SET    COUS_STAT_CD = '20'
	WHERE  DATE_FORMAT(NOW(), '%Y%m%d') > COUS_END_DT
	AND    COUS_STAT_CD = '10'
	</update>
	
</mapper>