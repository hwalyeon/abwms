<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="lect.hworkRegMng">
	
	<select id="selectTsCousHworkBase" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT 
		 A.COUS_NO
		,B.COUS_NM 
		,A.LECT_SEQ 
		,A.LECT_NM
		,A.HWORK_TYPE_CD
		,FN_CD_NM('HWORK_TYPE_CD', A.HWORK_TYPE_CD) AS HWORK_TYPE_NM 
		,C.HWORK_NM 
		,C.HWORK_DESC 
		,(SELECT MAX(SEQ) FROM TS_COUS_HWORK_DETL WHERE COUS_NO = C.COUS_NO AND LECT_SEQ = C.LECT_SEQ ) AS HWORK_CNT
	FROM TS_COUS_LECT A
	INNER JOIN TS_COUS_BASE B
	ON B.COUS_NO  = A.COUS_NO
	LEFT OUTER JOIN TS_COUS_HWORK_BASE C
	ON C.COUS_NO = A.COUS_NO
	AND C.LECT_SEQ = A.LECT_SEQ
	WHERE  A.COUS_NO  = #{cousNo}
	AND    A.LECT_SEQ = #{lectSeq}
	</select>
	
	<insert id="insertTsCousHworkBase" parameterType="java.util.Map">
	INSERT INTO TS_COUS_HWORK_BASE(
	      COUS_NO
		, LECT_SEQ
		, HWORK_NM
		, HWORK_DESC
		, REG_DT
		, REG_TM
		, REG_USER_ID
		, UPT_DT
		, UPT_TM
		, UPT_USER_ID
	) VALUES(
	      #{cousNo}
		, #{lectSeq}
		, #{hworkNm}
		, #{hworkDesc}
	    , DATE_FORMAT(NOW(), '%Y%m%d')
	    , DATE_FORMAT(NOW(), '%H%i%s')
	    , #{regUserId}
	    , DATE_FORMAT(NOW(), '%Y%m%d')
	    , DATE_FORMAT(NOW(), '%H%i%s')
	    , #{uptUserId}
	)
	</insert>
	
	<update id="updateTsCousHworkBase" parameterType="java.util.Map">
	UPDATE TS_COUS_HWORK_BASE
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	<if test=" hworkNm != null and hworkNm != '' ">
	      ,HWORK_NM     = #{hworkNm}				</if>
	<if test=" hworkDesc != null and hworkDesc != '' ">
	      ,HWORK_DESC = #{hworkDesc}			</if>
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</update>
	
	<delete id="deleteTsCousHworkBase" parameterType="java.util.Map">
	DELETE 
	FROM  TS_COUS_HWORK_BASE
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</delete>
	
	<update id="mergeTsCousHworkDetl" parameterType="java.util.Map" >		
	INSERT INTO TS_COUS_HWORK_DETL (
	  COUS_NO
	, LECT_SEQ
	, SEQ 
    , REG_DT
	, REG_TM
	, REG_USER_ID
	, UPT_DT
	, UPT_TM
	, UPT_USER_ID
	) VALUES (
	  #{cousNo}
	, #{lectSeq}
	, #{seq}  
	, DATE_FORMAT(NOW(), '%Y%m%d')
    , DATE_FORMAT(NOW(), '%H%i%s')
    , #{regUserId}
    , DATE_FORMAT(NOW(), '%Y%m%d')
    , DATE_FORMAT(NOW(), '%H%i%s')
    , #{uptUserId}
	)
	ON
		DUPLICATE KEY
	UPDATE
	  UPT_USER_ID = #{uptUserId}
	, UPT_DT = DATE_FORMAT(NOW(), '%Y%m%d')
	, UPT_TM = DATE_FORMAT(NOW(), '%H%i%s')
	</update>
	
	<delete id="deleteTsCousHworkDetl" parameterType="java.util.Map">
	DELETE 
	FROM  TS_COUS_HWORK_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    SEQ > #{hworkCnt}
	</delete>
	
	<delete id="deleteAllTsCousHworkDetl" parameterType="java.util.Map">
	DELETE 
	FROM  TS_COUS_HWORK_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	</delete>
	
	<select id="selectTsCousHworkDetl" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT 
		 A.COUS_NO
		,A.LECT_SEQ
		,A.SEQ 
		,A.QUST_TYPE_CD
		,FN_CD_NM('QUST_TYPE_CD', A.QUST_TYPE_CD) AS QUST_TYPE_NM
		,A.QUST_CNTN
		,A.ITEM_CNTN 
		,A.CORT_CNTN
		,A.APNT_VAL	
		,(SELECT MAX(SEQ) FROM TS_COUS_HWORK_DETL WHERE COUS_NO = A.COUS_NO AND LECT_SEQ = A.LECT_SEQ) AS MAX_SEQ
		,CASE WHEN (SELECT COUNT(1) FROM TS_HWORK_SOLV_DETL WHERE COUS_NO = A.COUS_NO AND LECT_SEQ = A.LECT_SEQ) > 0 THEN 'Y' ELSE 'N' END AS REG_END_YN
	FROM TS_COUS_HWORK_DETL A
	WHERE A.COUS_NO = #{cousNo}
	AND   A.LECT_SEQ = #{lectSeq}
	<if test=" seq != null and seq != '' ">
	AND   A.SEQ = #{seq}	
	</if>
	</select>
	
	<update id="updateTsCousHworkDetl" parameterType="java.util.Map" >
	UPDATE TS_COUS_HWORK_DETL
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	<if test=" qustTypeCd != null and qustTypeCd != '' ">
	      ,QUST_TYPE_CD = #{qustTypeCd}				</if>
	<if test=" qustCntn != null and qustCntn != '' ">
	      ,QUST_CNTN    = #{qustCntn}			</if>
	<if test=" itemCntn != null and itemCntn != '' ">
	      ,ITEM_CNTN    = #{itemCntn}			</if>
	<if test=" cortCntn != null and cortCntn != '' ">
	      ,CORT_CNTN    = #{cortCntn}			</if>
	<if test=" apntVal != null and apntVal != '' ">
	      ,APNT_VAL = #{apntVal}			</if>                       
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    SEQ = #{seq}
	</update>
	
	
	<update id="updateDelTsCousHworkDetl" parameterType="java.util.Map" >
	UPDATE TS_COUS_HWORK_DETL
	SET    UPT_DT       = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM       = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID  = #{uptUserId}
	      ,QUST_TYPE_CD = null
	      ,QUST_CNTN    = null
	      ,ITEM_CNTN    = null	
	      ,CORT_CNTN    = null
	      ,APNT_VAL     = null                       
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    SEQ = #{seq}
	</update>
	

</mapper>