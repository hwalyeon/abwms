<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="clss.hworkMng">

	<select id="selectCousList" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT A.COUS_NO
	      ,A.COUS_NM
	      ,A.COUS_DESC
	      ,A.ACDM_ID
	      ,(SELECT ACDM_NM
	        FROM   TO_ACDM_BASE
	        WHERE  ACDM_ID = A.ACDM_ID) AS ACDM_NM
	      ,A.LCTR_ID
	      ,B.LCTR_NM
	      ,A.COUS_STRT_DT
	      ,A.COUS_END_DT
		  ,A.STRT_TM
		  ,A.END_TM
	      ,A.STDT_LFEE
	      ,A.COUS_STAT_CD
	      ,FN_CD_NM('COUS_STAT_CD', A.COUS_STAT_CD) AS COUS_STAT_NM
	FROM   TS_COUS_BASE A
	       INNER JOIN TO_LCTR_BASE B
	       ON  B.LCTR_ID = A.LCTR_ID
	       INNER JOIN TS_COUS_STDT C
	       ON  C.COUS_NO = A.COUS_NO
	       AND C.COUS_STDT_STAT_CD IN ('20', '30')
	WHERE  1 = 1
<if test=" acdmId != null and acdmId != '' ">
	AND    A.ACDM_ID = #{acdmId}		</if>
<if test=" cousNo != null and cousNo != '' ">
	AND    A.COUS_NO = #{cousNo}		</if>
<if test=" cousNm != null and cousNm != '' ">
	AND    A.COUS_NM LIKE CONCAT('%', #{cousNm}, '%')		</if>
<if test=" lctrId != null and lctrId != '' ">
	AND    A.LCTR_ID = #{lctrId}		</if>
<if test=" lctrNm != null and lctrNm != '' ">
	AND    B.LCTR_NM LIKE CONCAT('%', #{lctrNm}, '%')		</if>
<if test=" stdtId != null and stdtId != '' ">
	AND    C.STDT_ID = #{stdtId}		</if>
<if test=" cousStatCd != null and cousStatCd != '' ">
	AND    A.COUS_STAT_CD = #{cousStatCd}		</if>
	ORDER BY A.COUS_NO
	</select>

	<select id="selectHworkList" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT B.ACDM_ID
	      ,(SELECT ACDM_NM
	        FROM   TO_ACDM_BASE
	        WHERE  ACDM_ID = B.ACDM_ID)               AS ACDM_NM
	      ,A.COUS_NO
	      ,A.LECT_SEQ
	      ,B.COUS_NM
	      ,A.LECT_NM
	      ,B.LCTR_ID
	      ,C.LCTR_NM
	      ,A.LECT_STRT_DTTM
	      ,DATE_FORMAT(A.LECT_STRT_DTTM, '%Y%m%d')    AS LECT_STRT_DT
	      ,DATE_FORMAT(A.LECT_STRT_DTTM, '%H%i%s')    AS LECT_STRT_TM
	      ,A.LECT_END_DTTM
	      ,DATE_FORMAT(A.LECT_END_DTTM , '%Y%m%d')    AS LECT_END_DT
	      ,DATE_FORMAT(A.LECT_END_DTTM , '%H%i%s')    AS LECT_END_TM
	      ,A.LECT_TCNT
	      ,A.LECT_URL
	      ,A.HWORK_TYPE_CD
	      ,FN_CD_NM('HWORK_TYPE_CD', A.HWORK_TYPE_CD) AS HWORK_TYPE_NM
	      ,D.HWORK_SBMT_DTTM 
	      ,CASE WHEN D.EVAL_YN IS NULL THEN 'N' ELSE D.EVAL_YN END AS EVAL_YN
	      ,D.HWORK_EVAL_SCOR
	FROM   TS_COUS_LECT A
	       INNER JOIN TS_COUS_BASE B
	       ON  B.COUS_NO = A.COUS_NO
	       INNER JOIN TO_LCTR_BASE C
	       ON  C.LCTR_ID = B.LCTR_ID
	       INNER JOIN TS_COUS_TAKE_DETL D
	       ON  D.COUS_NO  = A.COUS_NO
	       AND D.LECT_SEQ = A.LECT_SEQ
	       AND D.STDT_ID  = #{stdtId}
    WHERE  1 = 1
    AND    A.HWORK_TYPE_CD != '00'
    AND    EXISTS (SELECT 1
                   FROM   TS_COUS_STDT
                   WHERE  COUS_NO = A.COUS_NO
                   AND    COUS_STDT_STAT_CD IN ('20', '30')
                   AND    STDT_ID = #{stdtId})
<if test=" cousNo != null and cousNo != '' ">
    AND    A.COUS_NO = #{cousNo}					</if>
<if test=" lectSeq != null and lectSeq != '' ">
    AND    A.LECT_SEQ = #{lectSeq}					</if>
<if test=" cousNm != null and cousNm != '' " >
    AND    B.COUS_NM LIKE CONCAT('%', #{cousNm}, '%')	</if>
<if test=" lctrNm != null and lctrNm != '' " >
    AND    C.LCTR_NM LIKE CONCAT('%', #{lctrNm}, '%')	</if>
<if test=" lectNm != null and lectNm != '' " >
    AND    A.LECT_NM LIKE CONCAT('%', #{lectNm}, '%')	</if>
<if test=" lectDt != null and lectDt != '' " >
    AND    A.LECT_STRT_DTTM LIKE CONCAT(#{lectDt}, '%')	</if>
	ORDER BY A.COUS_NO, A.LECT_SEQ, A.LECT_STRT_DTTM
<if test=' paging == "Y" '>
	LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
	
	<select id="selectTsCousHworkBase" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT A.HWORK_NM
	      ,A.HWORK_DESC
	      ,B.HWORK_EVAL_SCOR
          ,B.TOT_EVAL_OPIN
	      ,CAST(B.HWORK_FILE_NO AS CHAR) AS HWORK_FILE_NO
	      ,C.FILE_PATH
	      ,C.LGIC_FILE_NM
	      ,C.PGIC_FILE_NM
	      ,CASE WHEN B.EVAL_YN IS NULL THEN 'N' ELSE B.EVAL_YN END AS EVAL_YN
	FROM   TS_COUS_HWORK_BASE A
	       INNER JOIN TS_COUS_TAKE_DETL B
	       ON  B.COUS_NO  = A.COUS_NO
	       AND B.LECT_SEQ = A.LECT_SEQ
	       LEFT OUTER JOIN TC_FILE C
	       ON  C.FILE_NO = B.HWORK_FILE_NO
	WHERE  1 = 1
	AND    A.COUS_NO  = #{cousNo}
	AND    A.LECT_SEQ = #{lectSeq}
	AND    B.STDT_ID  = #{stdtId}
	</select>
	
	<delete id="deleteTsCousHworkBase" parameterType="java.util.Map">
	DELETE
	FROM   TS_COUS_HWORK_BASE
	WHERE  COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq} 
	</delete>
	
	<select id="selectTsCousHworkDetl" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT SEQ
	      ,QUST_TYPE_CD
	      ,QUST_CNTN
	      ,ITEM_CNTN
	      ,CORT_CNTN
	      ,APNT_VAL
	FROM   TS_COUS_HWORK_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	ORDER BY SEQ
	</select>
	
	<delete id="deleteTsCousHworkDetl" parameterType="java.util.Map">
	DELETE
	FROM   TS_COUS_HWORK_DETL
	WHERE  COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq} 
	</delete>
	
	<select id="selectTsHworkSolvDetl" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT SEQ
	      ,ANSWER_CNTN
	      ,CORT_YN
	      ,EVAL_SCOR
	      ,EVAL_OPIN
	FROM   TS_HWORK_SOLV_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    STDT_ID  = #{stdtId}
	ORDER BY SEQ
	</select>
	
	<insert id="insertTsHworkSolvDetl" parameterType="java.util.Map">
	
	INSERT INTO TS_HWORK_SOLV_DETL
	(
		 COUS_NO
		,LECT_SEQ
		,STDT_ID
		,SEQ
		,ANSWER_CNTN
		,REG_DT
		,REG_TM
		,REG_USER_ID
		,UPT_DT
		,UPT_TM
		,UPT_USER_ID
	)
	SELECT  A.COUS_NO
	       ,A.LECT_SEQ
	       ,B.STDT_ID
	       ,A.SEQ
	       ,''
	       ,DATE_FORMAT(NOW(), '%Y%m%d')
		   ,DATE_FORMAT(NOW(), '%H%i%s')
		   ,#{regUserId}
		   ,DATE_FORMAT(NOW(), '%Y%m%d')
		   ,DATE_FORMAT(NOW(), '%H%i%s')
		   ,#{uptUserId}
	FROM   TS_COUS_HWORK_DETL A
	       INNER JOIN TS_COUS_STDT B
	       ON  B.COUS_NO           = A.COUS_NO
	       AND B.COUS_STDT_STAT_CD = '20'
	WHERE  1 = 1
	AND    A.COUS_NO  = #{cousNo}
	AND    A.LECT_SEQ = #{lectSeq} 
	
	</insert>
	
	<insert id="deleteTsHworkSolvDetl" parameterType="java.util.Map">
	
	DELETE 
	FROM   TS_HWORK_SOLV_DETL
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq} 
	
	</insert>
	
	<insert id="updateTsHworkSolvDetl" parameterType="java.util.Map">
	
	UPDATE TS_HWORK_SOLV_DETL
	SET    ANSWER_CNTN     = #{answerCntn}
		  ,UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID     = #{uptUserId}
	WHERE  1 = 1
	AND    COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    STDT_ID  = #{stdtId}
	AND    SEQ      = #{seq}

	</insert>
	
	<update id="updateHworkSbmt" parameterType="java.util.Map">
	
	UPDATE TS_COUS_TAKE_DETL
	SET    UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID     = #{uptUserId}
	      ,HWORK_SBMT_DTTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%s')
		<if test="hworkFileNo != null and hworkFileNo != '' ">
		  ,HWORK_FILE_NO   = #{hworkFileNo}</if>
	WHERE  COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    STDT_ID  = #{stdtId}
	
	</update>
	
	<update id="deleteHworkSbmt" parameterType="java.util.Map">
	
	UPDATE TS_COUS_TAKE_DETL
	SET    UPT_DT          = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM          = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID     = #{uptUserId}
	      ,HWORK_SBMT_DTTM = ''
		  ,HWORK_FILE_NO   = ''
	WHERE  COUS_NO  = #{cousNo}
	AND    LECT_SEQ = #{lectSeq}
	AND    STDT_ID  = #{stdtId}
	
	</update>
	
</mapper>