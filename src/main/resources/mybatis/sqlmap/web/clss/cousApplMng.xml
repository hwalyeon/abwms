<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="clss.cousApplMng">

	<select id="searchCousApplList" parameterType="java.util.Map" resultType="MybatisMap">
SELECT A.ACDM_ID
      ,B.ACDM_NM
      ,A.COUS_NO
      ,A.COUS_NM
      ,A.LCTR_ID
      ,C.LCTR_NM
      ,A.COUS_STRT_DT
      ,A.COUS_END_DT
      ,A.STRT_TM
      ,A.END_TM
      ,A.STDT_LFEE
      ,A.COUS_STAT_CD
      ,FN_CD_NM('COUS_STAT_CD', A.COUS_STAT_CD) AS COUS_STAT_NM
<if test=" stdtId != null and stdtId != '' ">
      ,FN_CD_NM('COUS_STDT_STAT_CD', D.COUS_STDT_STAT_CD) AS COUS_STDT_STAT_NM
      ,(CASE WHEN D.STDT_ID IS NOT NULL AND D.COUS_STDT_STAT_CD = '10' THEN 'Y' 
             WHEN D.STDT_ID IS NOT NULL AND D.COUS_STDT_STAT_CD = '90' THEN 'N'
             WHEN D.STDT_ID IS NULL THEN 'N' ELSE 'X' END ) AS APPL_YN
</if>
FROM   TS_COUS_BASE A
       INNER JOIN TO_ACDM_BASE B
       ON  B.ACDM_ID = A.ACDM_ID
       INNER JOIN TO_LCTR_BASE C
       ON  C.LCTR_ID = A.LCTR_ID
<if test=" stdtId != null and stdtId != '' ">
       LEFT OUTER JOIN TS_COUS_STDT D
       ON  D.COUS_NO = A.COUS_NO
       AND D.STDT_ID = #{stdtId}           </if>
WHERE  1 = 1
AND    A.COUS_STAT_CD IN ('10', '20')  /* 확정/종료상태 */
<if test=" acdmNm != null and acdmNm != '' ">
AND    B.ACDM_NM LIKE CONCAT('%', #{acdmNm}, '%')	</if>
<if test=" cousNo != null and cousNo != '' ">
AND    A.COUS_NO = #{cousNo}				</if>
<if test=" cousNm != null and cousNm != '' ">
AND    A.COUS_NM LIKE CONCAT('%', #{cousNm}, '%')	</if>
<if test=" lctrNm != null and lctrNm != '' ">
AND    C.LCTR_NM LIKE CONCAT('%', #{lctrNm}, '%')	</if>
ORDER BY A.COUS_STRT_DT, A.COUS_NM, B.ACDM_NM, C.LCTR_NM 
<if test=' paging == "Y" '>
LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
	
	<select id="searchLectApplList" parameterType="java.util.Map" resultType="MybatisMap">
SELECT A.COUS_NO
      ,A.LECT_SEQ
      ,A.LECT_NM
      ,A.LECT_METH_CD
      ,FN_CD_NM('LECT_METH_CD', A.LECT_METH_CD) AS LECT_METH_NM
      ,A.LECT_STRT_DTTM
      ,A.LECT_END_DTTM
      ,A.LECT_TCNT
FROM   TS_COUS_LECT A
WHERE  1 = 1
AND    A.COUS_NO = #{cousNo}
ORDER BY A.LECT_STRT_DTTM   
<if test=' paging == "Y" '>
	LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>
	
<select id="searchTsCousStdt" parameterType="java.util.Map" resultType="MybatisMap">
SELECT A.COUS_NO
      ,A.STDT_ID
      ,A.COUS_STDT_STAT_CD
FROM   TS_COUS_STDT A
WHERE  1 = 1
AND    A.COUS_NO = #{cousNo}
AND    A.STDT_ID = #{stdtId}

	</select>
	
	<insert id="insertTsCousStdt" parameterType="java.util.Map">
	INSERT INTO TS_COUS_STDT
	(
	    COUS_NO
	   ,STDT_ID
	   ,COUS_STDT_STAT_CD
	   ,REG_DT
	   ,REG_TM
	   ,REG_USER_ID
	   ,UPT_DT
	   ,UPT_TM
	   ,UPT_USER_ID

	)
	VALUES
	(
	    #{cousNo}
	   ,#{stdtId}
	   ,#{cousStdtStatCd}
       ,DATE_FORMAT(NOW(), '%Y%m%d')
       ,DATE_FORMAT(NOW(), '%H%i%s')
       ,#{regUserId}
       ,DATE_FORMAT(NOW(), '%Y%m%d')
       ,DATE_FORMAT(NOW(), '%H%i%s')
       ,#{uptUserId}
	)
	</insert>
	
	<update id="updateTsCousStdt" parameterType="java.util.Map">
	UPDATE TS_COUS_STDT
	SET    UPT_DT            = DATE_FORMAT(NOW(), '%Y%m%d')
	      ,UPT_TM            = DATE_FORMAT(NOW(), '%H%i%s')
	      ,UPT_USER_ID       = #{uptUserId}
	      ,COUS_STDT_STAT_CD = #{cousStdtStatCd}
	WHERE  1 = 1
	AND    COUS_NO = #{cousNo}
	AND    STDT_ID = #{stdtId}  
	</update>
	
	<delete id="deleteTsCousStdt" parameterType="java.util.Map">
	DELETE
	FROM   TS_COUS_STDT
	WHERE  1 = 1
	AND    COUS_NO = #{cousNo}
	AND    STDT_ID = #{stdtId}
	</delete>
</mapper>