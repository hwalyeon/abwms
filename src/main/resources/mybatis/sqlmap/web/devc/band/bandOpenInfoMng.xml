<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="devc.band.bandOpenInfoMng">

    <!--밴드/개통정보_리스트 조회-->
	<select id="selectBandOpenInfoList" parameterType="java.util.Map" resultType="MybatisMap">

		with BAND_YTYP_WITH as
		(
		select  TBI.BAND_ID
			  , case when cast(SUBSTRING(TBI.BAND_ID, 1,1) AS INTEGER)   <![CDATA[<]]> 2
			    then '203'|| SUBSTRING(TBI.BAND_ID, 1,1) || SUBSTRING(TBI.BAND_ID, 2,2)
				else '202'|| SUBSTRING(TBI.BAND_ID, 1,1) || SUBSTRING(TBI.BAND_ID, 2,2) end AS BAND_YTYP
		      , case when TBI.API_URL_DTTM is not null then 'Y' else 'N' end as API_URL_YN --URL제공여부
		from    TS_BAND_INFO as TBI
		)
		select	TBI.BAND_ID as BAND_ID_TEMP
			  , TBI.UPT_DT
			  , TBI.REG_DT
			  , TBI.BAND_ID
			  , T1.BAND_YTYP
			  , TBI.BAND_MDL_CD
			  , TSB.STDT_NO  --학생번호
			  , TBI.TEL_NO
			  , TSB.STDT_NM  --학생명
			  , TSB.GUAR_NO
			  , TBI.BAND_OPEN_STAT_CD
			  , TGB.GUAR_NM --보호자_명
			  , TBI.GUAR_TEL_NO --보호자_전화번호
			  , TBI.OPEN_GRAM_NO
			  , TBI.BLTH_ID
			  , TBI.API_URL_GRAM_NO --API URL 제공여부
			  , TBI.API_URL_DTTM
			  , T1.API_URL_YN
			  , TBI.REG_DT
			  , TBI.REG_TM
			  , TBI.REG_USER_ID
			  , TBI.UPT_DT
			  , TBI.UPT_TM
			  , TBI.UPT_USER_ID
		from    TS_BAND_INFO AS TBI
		left outer join TM_STDT_BASE   AS TSB
		on      TBI.BAND_ID = TSB.BAND_ID
		left outer join TM_GUAR_BASE   AS TGB
		on      TSB.GUAR_NO = TGB.GUAR_NO
		left outer join BAND_YTYP_WITH AS T1
		on      TBI.BAND_ID = T1.BAND_ID
		where 1=1
		<if test="uptDtFr != null and uptDtTo != null and uptDtFr !='' and uptDtTo !='' ">
		and TBI.UPT_DT between #{uptDtFr} and #{uptDtTo}</if>
	 	<if test=" stdtNm != null and stdtNm !='' ">
		and TSB.STDT_NM like CONCAT('%',#{stdtNm},'%')</if>
	 	<if test= "bandTelNo != null and bandTelNo !='' ">
		and TBI.TEL_NO   = #{bandTelNo}</if>
		<if test= "bandYtypCd != null and bandYtypCd !='' ">
		and T1.BAND_YTYP like CONCAT('%',#{bandYtypCd},'%')</if>
	 	 <if test= "bandId != null and bandId !='' ">
		and TBI.BAND_ID like CONCAT('%',#{bandId},'%')</if>
	 	 <if test= "bandOpenStatCd != null and bandOpenStatCd !='' ">
		and TBI.BAND_OPEN_STAT_CD  = #{bandOpenStatCd}</if>
	 	 <if test= "guarNm != null and guarNm !='' ">
		and TGB.GUAR_NM   like CONCAT('%',#{guarNm},'%')</if>
	 	 <if test= "guarTelNo != null and guarTelNo !='' ">
		and TGB.GUAR_TEL_NO  = #{guarTelNo}</if>

		<if test=' paging == "Y" '>
			LIMIT ${rowCount} OFFSET ${currentIndex} </if>
	</select>


	<insert id="insertTsBandInfoList" parameterType="java.util.Map">
    /*	INSERT INTO  TI_DD_NUTR_EAT_BLCK
    	(
		      SEX_CD
			, AGE_YCNT
			, NUTR_CD
			, EAT_QTY_FR
			, EAT_QTY_TO
			, NUTR_STAT_CD
			, USE_YN
			, REG_DT
			, REG_TM
			, REG_USER_ID
			, UPT_DT
			, UPT_TM
			, UPT_USER_ID
    	)
    	VALUES
    	(
    	     #{sexCd}
    	   , #{ageYcnt}::NUMERIC
    	   , #{nutrCd}
    	   , #{eatQtyFr}::NUMERIC
    	   , #{eatQtyTo}::NUMERIC
    	   , #{nutrStatCd}
    	   , #{useYn}
	       , TO_CHAR(NOW(), 'YYYYMMDD')
	       , TO_CHAR(NOW(), 'HH24MISS')
	       , #{regUserId}
	       , TO_CHAR(NOW(), 'YYYYMMDD')
	       , TO_CHAR(NOW(), 'HH24MISS')
	       , #{uptUserId}
    	)*/
    </insert>

	<update id="updateTsBandInfoList" parameterType="java.util.Map">
<!--		UPDATE TI_DD_NUTR_EAT_BLCK
		SET         UPT_DT           = TO_CHAR(NOW(), 'YYYYMMDD')
		            ,  UPT_TM           = TO_CHAR(NOW(),'HH24MISS')
	             	,  UPT_USER_ID  = #{uptUserId}
		<if test="sexCd != null and sexCd !=''">  ,SEX_CD = #{sexCd}</if>
		<if test="ageYcnt != null and ageYcnt != ''">  ,AGE_YCNT = #{ageYcnt}::NUMERIC</if>
		<if test="nutrCd != null and nutrCd != ''">  ,NUTR_CD = #{nutrCd}</if>
		<if test="eatQtyFr != null and eatQtyFr != ''">  ,EAT_QTY_FR = #{eatQtyFr}::NUMERIC</if>
		<if test="eatQtyTo != null and eatQtyTo != ''">  ,EAT_QTY_TO = #{eatQtyTo}::NUMERIC</if>
		<if test="nutrStatCd != null and nutrStatCd !=''">, NUTR_STAT_CD = #{nutrStatCd}</if>
		<if test="useYn != null and useYn !=''">, USE_YN = #{useYn}</if>
		WHERE  1=1
		AND SEX_CD         = #{sexCdTemp}
		AND AGE_YCNT    = #{ageYcntTemp}::NUMERIC
		AND NUTR_CD      = #{nutrCdTemp}
		AND EAT_QTY_FR  = #{eatQtyFrTemp}::NUMERIC-->
	</update>

	<delete id ="deleteTsBandInfoList" parameterType="java.util.Map">
/*        DELETE
        FROM    TI_DD_NUTR_EAT_BLCK
        WHERE  1=1
		AND SEX_CD          = #{sexCdTemp}
		AND AGE_YCNT     = #{ageYcntTemp}::NUMERIC
		AND NUTR_CD      = #{nutrCdTemp}
		AND EAT_QTY_FR = #{eatQtyFrTemp}::NUMERIC*/
	</delete>
	<!--밴드_ID_중복 조회-->
	<select id="selectBandId" parameterType="java.util.Map" resultType="MybatisMap">
	SELECT BAND_ID
	FROM   TS_BAND_INFO
	WHERE  1=1
	AND    BAND_ID = #{bandId}
	</select>

	<!--밴드_ID_채번 -->
	<select id="selectBandId" parameterType="java.util.Map" resultType="MybatisMap">

	select
	#{bandYtypCd} || #{bandMdlCd}|| to_char(coalesce(cast(max(substring(band_id ,5,6)) as integer) , 0) + 1  , 'FM000000')
	from TS_BAND_INFO
	where SUBSTRING(BAND_ID, 1, 4) = #{bandYtypCd}||#{bandMdlCd}
	;
	</select>

</mapper>